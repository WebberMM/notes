#+TITLE: Modal Logic
#+AUTHOR: wugouzi

#+EXPORT_FILE_NAME: ../latex/ModalLogic/ModalLogic.tex
#+LATEX_HEADER: \input{../preamble.tex}
#+LATEX_HEADER: \graphicspath{{../images/ModalLogic}}
#+LATEX_HEADER: \newcommand{\ue}{\fu\fe}
#+LATEX_HEADER: \newcommand{\ua}{\und{a}}
* Basic Concepts
** Modal Languages
   #+ATTR_LATEX: :options []
   #+BEGIN_definition
   The *basic modal language* is defined using  a set of *proposition letters* \Phi
   whose elements are usually denoted \(p,q,r\) and so on, and a unary modal
   operator \(\lozenge\). The well-formed *formulas* \phi of the basic modal
   language are given by the rule
   \begin{equation*}
   \phi:=p\mid\bot\mid\neg\phi\mid\psi\vee\phi\mid\lozenge\phi
   \end{equation*}
   #+END_definition

   \(\fM,w\Vdash\phi\)
   #+ATTR_LATEX: :options []
   #+BEGIN_definition
   A *modal similarity type* is a pair \(\tau=(O,\rho)\) where \(O\) is a non-empty
   set, and \rho is a function \(O\to\N\). The elements of \(O\) are called *modal
   operators*; we use \(\triangle\), \(\triangle_0,\triangle_1,\dots\) to denote
   elements of \(O\). The function \rho assigns to each operator \(\delta\in O\) a
   finite *arity*
   #+END_definition

   #+ATTR_LATEX: :options []
   #+BEGIN_definition
   A *modal language* \(ML(\tau,\Phi)\) is built up using a modal similarity type
   \(\tau=(O,\rho)\) and a set of proposition letters \Phi. The set \(Form(\tau,\Phi)\) of
   *modal formulas* over \tau and \Phi is given by the rule
   \begin{equation*}
   \phi:=p\mid\bot\mid\neg\phi\mid\phi_1\vee\phi_2\mid\triangle(\phi_1,\dots,\phi_{\rho(\triangle)})
   \end{equation*}
   where \(p\) ranges over elements of \Phi
   #+END_definition

   #+ATTR_LATEX: :options []
   #+BEGIN_definition
   For each \(\triangle\in O\) the *dual* \(\triangledown\) of \(\triangle\) is defined
   as \(\triangledown(\phi_1,\dots,\phi_n):=\neg\triangle(\neg\phi_1,\dots,\neg\phi_n)\)
   #+END_definition

   #+ATTR_LATEX: :options [The Basic Temporal Language]
   #+BEGIN_examplle
   The basic temporal language is built using a set of unary operators \(O=\{\la
   F\ra,\la P\ra\}\). The intended interpretation of a formula \(\la F\ra\phi\)
   is ' \phi will be true at some Future time' and the intended interpretation of
   \(\la P\ra\phi\) is ' \phi was true at some Past time.' This language is called
   the *basic temporal language*. Their duals are written as \(G\) and \(H\) ('it
   is Going to be the case' and 'it always Has been the case')

   Let's denote the converse of a relation \(R\) by \(R^\smallsmile\). We will
   call a frame of the form \((T,R,R^\smallsmile)\) a *bidirectional frame*, and a
   model built over such a frame a *bidirectional model*. From now on, we will
   only interpret basic temporal language in bidirectional models. That is, if
   \(\fM=(T,R,R^\smallsmile,V)\) is a bidirectional model then
   \begin{align*}
   \fM,t\Vdash F\phi \quad&\text{ iff }\quad
   \exists s(Rts\wedge \fM,s\Vdash\phi)\\
   \fM,t\Vdash P\phi \quad&\text{ iff }\quad
   \exists s(R^\smallsmile ts\wedge \fM,s\Vdash\phi)
   \end{align*}
   #+END_examplle

   #+ATTR_LATEX: :options [An Arrow Language]
   #+BEGIN_examplle
   The type \(\tau_\to\) of *arrow logic* is a similarity type with modal
   operators other than diamonds. The language of arrow logic is designed to
   talk about the objects in arrow structures. The well-formed formulas \phi are
   given by
   \begin{equation*}
   \phi:=p\mid\bot\mid\neg\phi\mid\phi\vee\psi\mid\phi\circ\psi\mid
   \otimes\phi\mid 1'
   \end{equation*}
   1' ('identity') is a nullary modality, the 'converse' operator \(\otimes\) is
   a diamond, and the 'composition' operator \(\circ\) is a dyadic operator.
   Possible readings of these operators are:
   \begin{alignat*}{3}
   &1'&&\text{identity}&&\text{'skip'}\\
   &\otimes\phi&&\text{converse}&&\text{'\(\phi\) conversely'}\\
   &\phi\circ\psi\quad&&\text{composition}\quad&&\text{'first \(\phi\), then \(\psi\)'}
   \end{alignat*}
   #+END_examplle
** Models and Frames
   #+ATTR_LATEX: :options []
   #+BEGIN_definition
   A *frame* for the basic modal language is a pair \(\fF=(W,R)\) s.t.
   1. \(W\) is a non-empty set
   2. \(R\) is a binary relation on \(W\)


   A *model* for the basic modal language is a pair \(\fM=(\fF,V)\), where \(\fF\)
   is a frame for the basic modal language and \(V\) is a function assigning to
   each proposition letter \(p\) in \Phi a subset \(V(p)\) of \(W\). The function
   \(V\) is called a *valuation*. \(\fM\) is *based on* the frame \(\fF\)
   #+END_definition

   #+ATTR_LATEX: :options []
   #+BEGIN_definition
   Suppose \(w\) is a state in a model \(\fM=(W,R,V)\). Then \phi is *satisfied* in
   \(\fM\) at state \(w\) if
   \begin{align*}
   \fM,w\Vdash p&\quad\text{iff}\quad
   w\in V(p),\text{ where } p\in\Phi\\
   \fM,w\Vdash\bot&\quad\text{iff}\quad\text{never}\\
   \fM,w\Vdash\neg\phi&\quad\text{iff}\quad
   \text{not }\fM,w\Vdash\phi\\
   \fM,w\Vdash\phi\vee\psi&\quad\text{iff}\quad
   \fM,w\Vdash\phi\text{ or }\fM,w\Vdash\psi\\
   \fM,w\Vdash\lozenge\phi&\quad\text{iff}\quad
   \text{ for some }v\in W\text{ with }Rwv\text{ we have }\fM,v\Vdash\phi
   \end{align*}
   It follows that \(\fM,w\Vdash\Box\phi\) iff for all \(v\in W\) s.t.
   \(Rwv\), we have \(\fM,v\Vdash\phi\)
   #+END_definition

   #+ATTR_LATEX: :options []
   #+BEGIN_definition
   Let \tau be a modal similarity type. A *\(\tau\)-frame* is a tuple \(\fF\)
   consisting of the following ingredients
   1. a non-empty set \(W\)
   2. for each \(n\ge0\), and each \(n\)-ary modal operator \(\triangle\) in the
      similarity type \tau, an \((n+1)\)-ary relation \(R_{\triangle}\)
   #+END_definition

   \phi is *satisfied at a state \(w\)* in a model
   \(\fM=(W,\{R_{\triangle}\mid\triangle\in\tau\},V)\) when
   \(\rho(\triangle)\iffalse<\fi>0\) if
   \begin{align*}
   \fM,w\Vdash\triangle(\phi_1,\dots,\phi_n)\quad\text{iff}\quad&
   \text{for some }v_1,\dots,v_n\in W\text{ with } R_{\triangle} wv_1\dots v_n\\
   &\text{we have, for each }i,\fM,v_i\Vdash\phi_i
   \end{align*}

   When \(\rho(\triangle)=0\) we define
   \begin{equation*}
   \fM,w\Vdash\triangle \quad\text{ iff }\quad
   w\in R_{\triangle}
   \end{equation*}

   #+ATTR_LATEX: :options []
   #+BEGIN_definition
  The set of all formulas that are valid in a class of frames \(\sfF\)is called
  the *logic* of \(\sfF\) (notation: \(\Lambda_{\sfF}\))
   #+END_definition

** General Frames
   #+ATTR_LATEX: :options []
   #+BEGIN_definition
   Given an \((n+1)\)-ary relation \(R\) on a set \(W\), we define the following
   \(n\)-ary operation \(m_R\) on the power set \(\calp(W)\) of \(W\):
   \begin{equation*}
   m_R(X_1,\dots,X_n)=\{w\in W\mid Rww_1\dots w_n\text{ for some }
   w_1\in X_1,\dots,w_n\in X_n\}
   \end{equation*}
   #+END_definition

* Models
** Invariance Results
   #+ATTR_LATEX: :options []
   #+BEGIN_definition
   Let \(\fM\) and \(\fM'\) be models of the same modal similarity type \tau, and
   let \(w\) and \(w'\) be states in \(\fM\) and \(\fM'\) respectively. The
   *\(\tau\)-theory* (or *\(\tau\)-type*) *of* \(w\) is the set of all
   \(\tau\)-formulas satisfied at \(w\): that is,
   \(\{\phi\mid\fM,w\Vdash\phi\}\). We say that \(w\) and \(w'\) are *(modally)
   equivalent* (\(w\leftrightsquigarrow w'\)) if they have the same \(\tau\)-theories

   The *\(\tau\)-theory* of the model \(\fM\) is the set of all \(\tau\)-formulas
   satisfied by all states in \(fM\); that is, \(\{\phi\mid\fM\Vdash\phi\}\)
   Models \(\fM\) and \(\fM'\) are called
   *(modally) equivalent* (\(\fM\leftrightsquigarrow\fM'\)) if their theories are identical
   #+END_definition

*** Disjoint Unions
*** Generated submodels
    #+ATTR_LATEX: :options []
    #+BEGIN_definition
    Let \(\fM=(W,R,V)\) and \(\fM'=(W',R',V')\) be two models; we say that
    \(\fM'\) is a *submodel* of \(\fM\) if \(W'\subseteq W\), \(R'\) is the
    restriction of \(R\) to \(W'\), and \(V'\) is the restriction of \(V\) to
    \(\fM'\). We say that \(\fM'\) is a *generated submodel* of \(\fM\)
    (\(\fM'\rightarrowtail\fM\)) if \(\fM'\) is a submodel of \(\fM\) and for
    all points \(w\) the following closure condition holds
    \begin{equation*}
    \text{if }w\text{ is in }\fM'\text{ and }Rwv,\text{ then }v\text{ is in }\fM'
    \end{equation*}

    Let \(fM\) be a model, and \(X\) a subset of the domain of \(\fM\); the
    *submodel generated by* \(X\) is the smallest generated submodel of \(\fM\)
    whose domain contains \(X\). A *rooted* or *point generated* model is a model
    that is generated by a singleton set, the element of which is called the
    *root* of the frame
    #+END_definition

*** Morphism for modalities
    #+ATTR_LATEX: :options [Homomorphisms]
    #+BEGIN_definition
    Let \tau be a modal similarity type and let \(\fM\) and \(\fM'\) be
    \tau-models. By a *homomorphism* \(f:\fM\to\fM'\), we mean a function \(f:W\to
    W'\) satisfying
    1. For each proposition letter \(p\) and each element \(w\) from \(\fM\), if
       \(w\in V(p)\), then \(f(w)\in V'(p)\)
    2. For each \(n\ge0\) and each \(n\)-ary \(\triangle\in\tau\) and
       \((n+1)\)-tuple \(\bbar{w}\) from \(\fM\), if \((w_0,\dots,w_n)\in
       R_{\triangle}\), then \((f(w_0),\dots,f(w_n))\in R_{\triangle}'\) (the
       *homomorphic condition*)
    #+END_definition

    #+ATTR_LATEX: :options [Strong Homomorphisms, Embeddings and Isomorphisms]
    #+BEGIN_definition
    Let \tau be a modal similarity type and let \(\fM\) and \(\fM'\) be
    \tau-models. By a *strong homomorphism* \(f:\fM\to\fM'\), we mean a function \(f:W\to
    W'\) satisfying
    1. For each proposition letter \(p\) and each element \(w\) from \(\fM\) iff
       \(w\in V(p)\), then \(f(w)\in V'(p)\)
    2. For each \(n\ge0\) and each \(n\)-ary \(\triangle\in\tau\) and
       \((n+1)\)-tuple \(\bbar{w}\) from \(\fM\) iff \((w_0,\dots,w_n)\in
       R_{\triangle}\), iff \((f(w_0),\dots,f(w_n))\in R_{\triangle}'\) (the
       *strong homomorphic condition*)


    An *embedding* of \(\fM\) into \(\fM'\) is a strong homomorphism
    \(f:\fM\to\fM'\) which is injective. An *isomorphism* is a bijective strong homomorphism
    #+END_definition

    #+ATTR_LATEX: :options []
    #+BEGIN_proposition
    Let \tau be a modal similarity type and let \(\fM\) and \(\fM'\) be
    \tau-models. Then the following holds
    1. for all elements \(w\) and \(w'\) of \(\fM\) and \(\fM'\), respectively,
       if there exists a surjective strong homomorphism \(f:\fM\to\fM'\) with
       \(f(w)=w'\), then \(w\) and \(w\) are modally equivalent
    2. If \(\fM\cong\fM'\), then \(\fM\leftrightsquigarrow\fM'\)
    #+END_proposition

    #+ATTR_LATEX: :options [Bounded Morphisms - the Basic Case]
    #+BEGIN_definition
    Let \(\fM\) and \(\fM'\) be models for the basic modal language. A mapping
    \(f:\fM=(W,R,V)\to\fM'=(W',R',V')\) is a *bounded morphsim* if it satisfies
    1. \(w\) and \(f(w)\) satisfy the same proposition letters
    2. \(f\) is a homomorphism w.r.t. the relation \(R\) (if \(Rwv\) then \(R'f(w)f(v)\))
    3. If \(R'f(w)v'\) then there exists \(v\) s.t. \(Rwv\) and \(f(v)=v'\) (the
       *back condition*)


    If there is a *surjective* bounded morphism from \(\fM\) to \(\fM'\), then we
    say that \(\fM'\) is a *bounded morphic image* of \(\fM\), and write
    \(\fM\twoheadrightarrow\fM'\)
    #+END_definition

    #+ATTR_LATEX: :options []
    #+BEGIN_proposition
    Let \tau be a modal similarity type and let \(\fM\) and \(\fM'\) be
    \(\tau\)-models s.t. \(f:\fM\to\fM'\) is a bounded morphism. Then for each
    modal formula \phi, and each element \(w\) of \(\fM\) we have
    \(\fM,w\Vdash\phi\) iff \(\fM',f(w)\Vdash\phi\).
    #+END_proposition


    Let \tau be a modal similarity type containing only diamonds (thus if \(\fM\)
    is a \(\tau\)-model, it has the form \((W,R_1,\dots,V)\) where each \(R_i\)
    is a binary relation on \(W\)) . In this context we will call a
    \(\tau\)-model \(\fM\) *tree-like* if the structure \((W,\bigcup_i R_i,V)\) is
    a tree

    #+ATTR_LATEX: :options []
    #+BEGIN_proposition
    label:prop2.15
    Assume that \tau is a modal similarity type containing only diamonds. Then for
    any rooted \(\tau\)-models \(\fM\) there exists a tree-like \(\tau\)-models
    \(\fM'\) s.t. \(\fM'\twoheadrightarrow\fM\). Hence any satisfiable
    \(\tau\)-formula is satisfiable in a tree-like model
    #+END_proposition

    #+BEGIN_proof
    Let \(w\) be the root of \(\fM\). Define the model \(\fM'\) as follows. Its
    domain \(W'\) consist of all finite sequences \((w,u_1,\dots,u_n)\) s.t.
    \(n\ge0\) and for some modal operators \(\la a_1\ra,\dots,\la
    a_n\ra\in\tau\) there is a path \(wR_{a_1}u_1\cdots R_{a_n}u_n\) in \(\fM\).
    Define \((w,u_1,\dots,u_n)R'_a(w,v_1,\dots,w_m)\) to hold if
    \(m=n+1,u_i=v_i\) for \(i=1,\dots,n\) and \(R_au_nv_m\) holds in \(\fM\).
    That is, \(R'_a\) relates two sequences iff the second is an extension of
    the first with a state from \(\fM\) that is a sucessor of the last element
    of the first sequence. Finally, \(V'\) is defined by putting
    \((w,u_1,\dots,u_n)\in V'(p)\) iff \(u_n\in V(p)\). The mapping
    \(f:(w,u_1,\dots,u_n)\mapsto u_n\) defines a surjective bounded morphism
    from \(\fM'\) to \(\fM\)
    #+END_proof




** Bisimulations
   #+ATTR_LATEX: :options [Bisimulation - the Basic Case]
   #+BEGIN_definition
   label:def2.16
   Let \(\fM=(W,R,V)\) and \(\fM=(W',R',V')\) be two models

   A non-empty binary relation \(Z\subseteq W\times W'\) is called a *bisimulation
   between* \(\fM\) and \(\fM'\) (notation: \(Z:\fM\leftrightarroweq\fM')\) if
   1. If \(wZw'\) then \(w\) and \(w'\) satisfy the same proposition letters
   2. If \(wZw'\) and \(Rwv\), then there exists \(v'\) (in \(\fM'\)) s.t.
      \(vZv'\) and \(R'w'v'\) (the *forth condition*)
   3. The converse of (2): if \(wZw'\) and \(R'w'v'\), then there exists \(v\)
      (in \(\fM\)) s.t. \(vZv'\) and \(Rwv\) (the *back condition*)


   When \(Z\) is a bisimulation linking two states \(w\) in \(\fM\) and \(w'\)
   in \(\fM'\) we say that \(w\) and \(w'\) are *bisimilar*, and we write
   \(Z:\fM,w\leftrightarroweq \fM',w'\). If there is a bisimulation, we sometimes
   write \(\fM,w\leftrightarroweq \fM',w'\) or \(w\leftrightarroweq w'\)
   #+END_definition

   #+ATTR_LATEX: :options [Bisimulation - the General Case]
   #+BEGIN_definition
   Let \tau be a modal similarity type, and let
   \(\fM=(W,R_{\triangle},V)_{\triangle\in\tau}\) and
   \(\fM'=(W',R_{\triangle}',V')_{\triangle\in\tau}\) be \(\tau\)-models. A
   non-empty binary relation \(Z\subseteq W\times W'\) is called a *bisimulation*
   between \(\fM\) and \(\fM'\) (\(Z:\fM\leftrightarroweq\fM'\)) if the above
   condition 1 is satisfied and
   2. [@2] If \(wZw'\) and \(R_{\triangle}wv_1\dots v_n\) then there are
      \(v_1',\dots,v_n'\in W'\) s.t. \(R'_{\triangle}w'v_1'\dots v_n'\) and for
      all \(i\) (\(1\le i\le n\)) \(v_iZv_i'\) (the *forth* condition)
   3. If \(wZw'\) and \(R'_{\triangle}w'v_1'\dots v_n'\) then there are
      \(v_1,\dots,v_n\in W\) s.t. \(R_{\triangle}wv_1\dots v_n\) and for
      all \(i\) (\(1\le i\le n\)) \(v_iZv_i'\) (the *back* condition)
   #+END_definition

   #+ATTR_LATEX: :options []
   #+BEGIN_proposition
   Let \tau be a modal similarity type, and let \(\fM,\fM'\) and \(\fM_i\) (\(i\in
   I\)) be \(\tau\)-models
   1. If \(\fM\cong\fM'\), then \(\fM\leftrightarroweq\fM'\)
   2. For every \(i\in I\), and every \(w\) in \(\fM_i\),
      \(\fM_i,w\leftrightarroweq\biguplus_i\fM_i,w\)
   3. If \(\fM'\rightarrowtail\fM\), then \(\fM',w\leftrightarroweq\fM,w\) for
      all \(w\) in \(\fM'\)
   4. If \(f:\fM\twoheadrightarrow\fM'\), then
      \(\fM,w\leftrightarroweq\fM',f(w)\) for all \(w\) in \(\fM\)
   #+END_proposition

   #+BEGIN_proof
   Suppose \(\fM=(W,R_{\triangle},V)_{\triangle\in\tau}\) and
   \(\fM'=(W',R_{\triangle}',V')_{\triangle\in\tau}\) 
   \(\fM_i\subseteq \biguplus_i\fM_i\)
   1. Suppose \(f:\fM\cong\fM'\), then we define \(wZw'\) iff \(w'=f(w)\) where
      \(w\in W,w'\in W'\). Bisimulation comes from the definition of the isomorphism
   2. Define the relation \(Z=\{(w,w)\mid
      w\in\fM_i\}\subseteq\fM_i\times\biguplus\fM_i\). The first condition comes
      from the invariance. The forth condition is obvious. For the back
      condition, if \(R_{\triangle}'w'v_1'\dots v_n'\) and \(w'\in W\), then
      \(v_1',\dots,v_n'\in W\) since each \(R_{\triangle,i}\) is disjoint and we
      have \(R_{\triangle,i}w'v_1'\dots v_n'\)
   3. Define the relation \(Z=\{(w,w)\mid w\in\fM'\}\subseteq\fM'\times\fM\).
      The first condition comes from the invariance. Forth condition is obvious.
      For the back condition, suppose \(wZw\) and \(R'_{\triangle}wv_1'\dots
      v_n'\), by the definition, \(v_1',\dots,v_n'\in W\) and
      \(R_{\triangle}wv_1'\dots v_n'\)
   4. Define \(Z=\{(w,f(w)\mid w\in W)\}\). The first condition comes from the
      definition. If \(wZw'\) and \(R_{\triangle}wv_1\dots v_n\), then
      \(R'_{\triangle}f(w)f(v_1)\dots f(v_n)\). If \(wZw'\) and
      \(R_{\triangle}'w'v_1'\dots v_n\), then there is \(v_1,\dots,v_n\) s.t.
      \(R_{\triangle}wv_1,\dots,v_n\) and \(f(v_i)=v_i'\) for \(1\le i\le n\)
   #+END_proof

   #+ATTR_LATEX: :options []
   #+BEGIN_theorem
   label:thm2.20
   Let \tau be a modal similarity type, and let \(\fM, \fM'\) be \(\tau\)-models.
   Then, for every \(w\in W\) and \(w'\in W'\), \(w\leftrightarroweq w'\)
   implies that \(w\leftrightsquigarrow w'\). In other words, modal formulas are
   invariant under bisimulation
   #+END_theorem

   #+BEGIN_proof
   Induction on the complexity of \phi.

   Suppose \phi is \(\diamond\psi\), we have \(\fM,w\Vdash\diamond\psi\) iff there
   exists a \(v\) in \(\fM\) s.t. \(Rwv\) and \(\fM,v\Vdash\psi\). As
   \(w\leftrightarroweq w'\), there exists a \(v'\) in \(\fM'\) s.t. \(R'w'v'\)
   and \(v\leftrightarroweq v'\). By the I.H., \(\fM',v'\Vdash\psi\), hence \(\fM',w'\Vdash\diamond\psi\)
   #+END_proof

   #+ATTR_LATEX: :options [Bisimulation and First-Order Logic]
   #+BEGIN_examplle
   label:example2.22

    [[/media/wu/file/stuuudy/notes/images/ModalLogic/BisimilarModels.png]]


   #+END_examplle

   #+ATTR_LATEX: :options []
   #+BEGIN_examplle
   label:example2.23

   [[/media/wu/file/stuuudy/notes/images/ModalLogic/NotBisimilar.png]]
   #+END_examplle

   \(\fM\) is *image-finite* if for each state \(u\) in \(\fM\) and each relation
   \(R\) in \(\fM\), the set \(\{(v_1,\dots,v_n)\mid Ruv_1\dots v_n\}\) is
   finite

   #+ATTR_LATEX: :options [Hennessy-Milner Theorem]
   #+BEGIN_theorem
   label:thm2.24
   Let \tau be a modal similarity type and let \(\fM\) and \(\fM'\) be two
   image-finite \(\tau\)-models. Then for every \(w\in W\) and \(w'\in W'\),
   \(w\leftrightarroweq w'\) iff \(w\leftrightsquigarrow w'\)
   #+END_theorem

   #+BEGIN_proof
   Assume that our similarity type \tau only contains a single diamond. The
   direction from left to right follows from Theorem ref:thm2.20

   Suppose \(w\leftrightsquigarrow w'\). The first condition is immediate. If
   \(Rwv\), assume there is no \(v'\) in \(\fM'\) with \(R'w'v'\) and
   \(v\leftrightsquigarrow v'\). Let \(S'=\{u'\mid R'w'u'\}\). Note that \(S'\)
   must be non-empty, for otherwise \(\fM',w'\Vdash\Box\bot\), which would
   contradict \(w\leftrightsquigarrow w'\) since \(\fM,w\Vdash\diamond\top\).
   Furthermore, as \(\fM'\) is image-finite, \(S'\) must be finite, say
   \(S'=\{w_1',\dots,w_n'\}\). By assumption, for every \(w_i'\in S'\) there
   exists a formula \(\psi_i\) s.t. \(\fM,v\Vdash\psi_i\), but
   \(\fM',w_i'\not\Vdash\psi_i\). It follows that
   \begin{equation*}
   \fM,w\Vdash\diamond(\psi_1\wedge\dots\wedge\psi_n)\quad\text{ and }\quad
   \fM',w'\not\Vdash\diamond(\psi_1\wedge\dots\wedge \psi_n)
   \end{equation*}
   #+END_proof

   #+BEGIN_exercise
   label:ex2.2.8
   Suppose that \(\{Z_i\mid i\in I\}\) is a non-empty collection of
   bisimulations between \(\fM\) and \(\fM'\). Prove that the relation
   \(\bigcup_{i\in I}Z_i\) is also a bisimulation between \(\fM\) and \(\fM'\).
   Conclude that if \(\fM\) and \(\fM'\) are bisimilar, then there is a maximal
   bisimulation between \(\fM\) and \(\fM'\).
   #+END_exercise

   #+BEGIN_proof
   1. If \((w,w')\in\bigcup_{i\in I}Z_i\), then \((w,w')\in Z_j\) for some
      \(j\in I\) and hence they satisfy the same propositional letters
   2. If \((w,w')\in\bigcup_{i\in I}Z_i\) and \(R_{\triangle}wv_1\dots v_n\),
      since \((w,w')\in Z_j\) for some \(j\in I\), we have
      \(R'_{\triangle}w'v_1'\dots v_n'\) and \(v_iZ_jv_i'\) for all \(1\le i\le
      n\), which means \((v_i,v_i')\in\bigcup_{i\in I}Z_i\) for all \(1\le i\le n\)
   3. similarly
   #+END_proof

   #+ATTR_LATEX: :options [Bisimulations for the Basic Temporal Language and Arrow Logic]
   #+BEGIN_remark
   When working with the basic temporal language, we usually work with models
   \((W,R,V)\) and implicitly take \(R_p\) to be \(R^\smallsmile\). Thus we need
   a notion of bisimulation between models \((W,R,V)\) and \((W',R',V')\) to be
   a relation \(Z\) between the states of the two models that satisfies the
   clauses of Definition ref:def2.16, and in addition the following
   4. [@4] If \(wZw'\) and \(Rvw\), then there exists \(v'\) in \(\fM'\) s.t.
      \(vZv'\) and \(R'v'w'\)
   5. Converse of 4: if \(wZw'\) and \(R'v'w'\), then there exists \(v\) in
      \(\fM\) s.t. \(vZv'\)
   #+END_remark

** Finite Models
   #+ATTR_LATEX: :options [Finite Model Property]
   #+BEGIN_definition
   Let \tau be a modal similarity type, and let \(\sfM\) be a class of
   \(\tau\)-models. We say that \tau has the *finite model property w.r.t.* \(\sfM\)
   if the following holds: if \phi is a formula of similarity type \tau, and \phi is
   satisfiable in some model in \(\sfM\), then \phi is satisfiable in a *finite*
   model in \(\sfM\)
   #+END_definition
*** Selecting a finite submodel
    #+ATTR_LATEX: :options [Degree]
    #+BEGIN_definition
    We define the *degree* of modal formulas as follows:
    \begin{align*}
    \deg(p)\quad&=\quad 0\\
    \deg(\bot)\quad&=\quad0\\
    \deg(\neg\phi)\quad&=\quad\deg(\phi)\\
    \deg(\phi\vee\psi)\quad&=\quad\max\{\deg(\phi),\deg(\psi)\}\\
    \deg(\triangle(\phi_1,\dots,\phi_n))\quad&=\quad
    1+\max\{\deg(\phi_1),\dots,\deg(\phi_2)\}
    \end{align*}
    #+END_definition

    #+ATTR_LATEX: :options []
    #+BEGIN_proposition
    label:prop2.29
    Let \tau be a finite modal similarity type, and assume our collection of
    proposition letters is finite as well
    1. for all \(n\), up to logical equivalence there are only finitely many
       formulas of degree at most \(n\)
    2. for all \(n\), and every \(\tau\)-model \(\fM\) and state \(w\) of
       \(\fM\), the set of all \(\tau\)-formulas of degree at most \(n\) that
       are satisfied by \(w\), is equivalent to a single formula
    #+END_proposition

    #+ATTR_LATEX: :options [$n$-Bisimulation]
    #+BEGIN_definition
    Let \(\fM\) and \(\fM'\) be models, and let \(w\) and \(w'\) be states of
    \(\fM\) and \(\fM'\), respectively. We say that \(w\) and \(w'\) are
    *\(n\)-bisimilar* (\(w\leftrightarroweq_nw'\)) if there exists a sequence of
    binary relations \(Z_n\subseteq\cdots\subseteq Z_0\) with the following
    properties (for \(i+1\le n\))
    1. \(wZ_nw'\)
    2. if \(vZ_0v'\) then \(v\) and \(v'\) agree on all proposition letters
    3. if \(vZ_{i+1}v'\) and \(Rvu\) then there exists \(u'\) with \(R'v'u'\)
       and \(uZ_iu'\)
    4. if \(vZ_{i+1}v'\) and \(R'v'u'\), then there exists \(u\) with \(Rvu\)
       and \(uZ_iu'\)
    #+END_definition

    #+ATTR_LATEX: :options []
    #+BEGIN_proposition
    label:prop2.31
    Let \tau be a finite modal similarity type, \Phi a finite set of proposition
    letters, and let \(\fM\) and \(\fM'\) be models for this language. Then for
    every \(w\) in \(\fM\) and \(w'\) in \(\fM'\), the following are equivalent
    1. \(w\leftrightarroweq_nw'\)
    2. \(w\) and \(w'\) agree on all modal formulas of degree at most \(n\).
    #+END_proposition

    #+BEGIN_proof
    \(2\to 1\). if \(n=0\), obvious.

    If \(n=k\) and the proposition holds. Now suppose \(n=k+1\). Now \(w\) and
    \(w'\) agree on all modal formulas of degree at most \(n+1\). If
    there is not \(v,v'\) s.t. \(v\) and \(v'\) agree on all modal formulas of
    degree at most \(n\) and \(Rwv\) and \(Rwv'\). Let \(S'=\{u'\mid R'w'u'\}\)
    and \(S'\) is finite, say \(S'==\{w_1',\dots,w_n'\}\). By assumption, for
    every \(w_i'\in S'\) there exists a formula \(\psi_i\)  of degree at most
    \(n\) s.t. \(\fM,v\Vdash\psi_i\) but \(\fM',w_i'\not\Vdash\psi_i\). It
    follows that
    \begin{equation*}
    \fM,w\Vdash\diamond(\psi_1\wedge\dots\wedge\psi_n)
    \text{ and }
    \fM',w'\not\Vdash\diamond(\psi_1\wedge\dots\wedge\psi_n)
    \end{equation*}
    #+END_proof

    #+ATTR_LATEX: :options []
    #+BEGIN_definition
    Let \tau be a modal similarity type containing only diamonds. Let
    \(\fM=(W,R_1,\dots,R_n,\dots,V)\) be a rooted \(\tau\)-model with root
    \(w\). The notion of the *height* of states in \(\fM\) is defined by
    induction.

    The only element of height 0 is the rot of the model; the states of height
    \(n+1\) are those immediate successors of elements of height \(n\) that have
    not yet assigned a height smaller than \(n+1\). The *height of a model* \(\fM\)
    is the maximum \(n\) s.t. there is a state of height \(n\) in \(\fM\), if
    such a maximum exists; otherwise the height of \(\fM\) is infinite

    For a natural number \(k\), the *restriction* of \(\fM\) to \(k\)
    (\(\fM\restriction k\)) is defined as the submodel containing only states
    whose height is at most \(k\). \((\fM\restriction
    k)=(W_k,R_{1k},\dots,R_{nk},\dots,V_k)\), where
    \(W_k=\{v\mid\text{height}(v)\le k\}\), \(R_{nk}=R_n\cap(W_k\times W_k)\),
    and for each \(p\), \(V_k(p)=V(p)\cap W_k\)
    #+END_definition


    #+ATTR_LATEX: :options []
    #+BEGIN_lemma
    label:lemma2.33
    Let \tau be a modal similarity type that contains only diamonds. Let \(\fM\) be
    a rooted \(\tau\)-models, and let \(k\) be a natural number. Then for every
    state \(w\) of \((\fM\restriction k)\), we have \((\fM\restriction
    k),w\leftrightarroweq_l\fM,w\), where \(l=k-\text{height}(w)\)
    #+END_lemma

    #+ATTR_LATEX: :options [Finite Model Property - via Selection]
    #+BEGIN_theorem
    Let \tau be a modal similarity type containing only diamonds, and let \phi be a
    \(\tau\)-formula. If \phi is satisfiable, then it is satisfiable on a finite model
    #+END_theorem

    #+BEGIN_proof
    Fix a modal formula \phi with \(\deg(\phi)=k\). We restrict our modal similarity
    type \tau and our collection of proposition letters to the modal operators and
    proposition letters actually occurring in \phi. Let \(\fM_1,w_1\) be s.t.
    \(\fM_1,w_1\Vdash\phi\). By Proposition ref:prop2.15, there exists a
    tree-like model \(\fM_2\) with root \(w_2\) s.t. \(\fM_2,w_2\Vdash\phi\).
    Let \(\fM_3:=(\fM_2\restriction k)\). By Lemma ref:lemma2.33 we have
    \(\fM_2,w_2\leftrightarroweq_k\fM_3,w_2\) and by Proposition ref:prop2.31 it
    follows that \(\fM_3,w_2\Vdash\phi\)

    By induction on \(n\le k\) we define finite sets of states \(S_0,\dots,S_k\)
    and a (final) model \(\fM_4\) with domain \(S_0\cup\cdots\cup S_k\); the
    points in each \(S_n\) will have height \(n\)

    Define \(S_0\) to be the singleton \(\{w_2\}\). Next, assume that
    \(S_0,\dots,S_n\) have already been defined. Fix an element \(v\) of
    \(S_n\). By Proposition ref:prop2.29 there are only finitely many
    non-equivalent modal formulas whose degree is at most \(k-n\), say
    \(\psi_1,\dots,\psi_m\). For each formula that is of the form \(\la
    a\ra\chi\) and holds in \(\fM_3\) at \(v\), select a state \(u\) from
    \(\fM_3\) s.t. \(R_avu\) and \(\fM_3,u\Vdash\chi\). Add all these \(u\)s to
    \(S_{n+1}\), and repeat this selection process for every state in \(S_n\).
    \(S_{n+1}\) is defined as the set of all points that have been selected in
    this way

    Finally, define \(\fM_4\) as follows. Its domain is \(S_0\cup\dots\cup
    S_k\); as each \(S_i\) is finite, \(\fM_4\) is finite. The relations and
    valuation are obtained by restricting the relations and valuations of
    \(\fM_3\) to the domain of \(\fM_4\)
    #+END_proof
*** Finite models via filtrations

    #+ATTR_LATEX: :options []
    #+BEGIN_definition
    A set of formulas \Sigma is *closed under subformulas* (or *subformula closed*) if
    for all formulas \phi, \(\phi'\): if \(\phi\vee\phi'\in\Sigma\) then so are
    \(\phi\) and \(\phi'\); if \(\neg\phi\in\Sigma\) then so is \phi; and if
    \(\triangle(\phi_1,\dots,\phi_n)\in\Sigma\) then so are \(\phi_1,\dots,\phi_n\)
    #+END_definition

    #+ATTR_LATEX: :options [Filtrations]
    #+BEGIN_definition
    We work in the basic modal language. Let \(\fM=(W,R,V)\) be a model and \Sigma a
    subformula closed set of formulas. Let \(\leftrightsquigarrow_\Sigma\) be
    the relation on the states of \(\fM\) defined by
    \begin{equation*}
    w\leftrightsquigarrow_\Sigma v \text{ iff for all }\phi\in\Sigma:
    (\fM,w\Vdash\phi\text{ iff }\fM,v\Vdash\phi)
    \end{equation*}
    Note that \(\leftrightsquigarrow_\Sigma\) is an equivalence relation. We
    denote the equivalence class of a state \(w\) of \(\fM\) w.r.t.
    \(\leftrightsquigarrow_\Sigma\) by \(\abs{w}_\Sigma\), or simply
    \(\abs{w}\). The mapping \(w\mapsto\abs{w}\) is called the *natural map*

    Let \(W_\Sigma=\{\abs{w}_\Sigma\mid w\in W\}\). Suppose \(\fM_\Sigma^f\) is
    any model \((W^f,R^f,V^f)\) s.t.
    1. \(W^f=W_\Sigma\)
    2. if \(Rwv\) then \(R^f\abs{w}\abs{v}\)
    3. if \(R^f\abs{w}\abs{v}\) then for all \(\diamond\phi\in\Sigma\), if
       \(\fM,v\Vdash\phi\) then \(\fM,w\Vdash\diamond\phi\)
    4. \(V^f(p)=\{\abs{w}\mid\fM,w\Vdash p\}\), for all proposition letters
       \(p\) in \Sigma


    \(\fM_\Sigma^f\) is called a *filtration of \(fM\) through* \Sigma; we will
    often suppress subscripts and write \(\fM^f\) instead of \(\fM_\Sigma^f\)
    #+END_definition
    label:def2.36
    #+ATTR_LATEX: :width 6cm
    [[/media/wu/file/stuuudy/notes/images/ModalLogic/Filtration.png]]

    Let \(\fM=(\N,R,V)\) , where \(R=\{(0,1),(0,2),(1,3)\}\cup\{(n,n+1)\mid
    n\ge2\}\), and \(V\) has \(V(p)=\N\setminus\{0\}\) and \(V(q)=\{2\}\)

    Further assume \(\Sigma=\{\diamond p,p\}\). \Sigma is subformula closed. Then,
    the model
    \(\fN=(\{\abs{0},\abs{1}\},\{(\abs{0},\abs{1}),(\abs{1},\abs{1})\},V')\),
    where \(V'(p)=\{\abs{1}\}\) is a filtration of \(\fM\) through \Sigma. \(\fN\) is
    not a bounded morphic image of \(\fM\): any bounded morphism would have to
    preserve the formula \(q\)

    #+ATTR_LATEX: :options []
    #+BEGIN_proposition
    Let \Sigma be a finite subformula closed set of basic modal formulas. For any
    model \(\fM\), if \(\fM^f\) is a filtration of \(\fM\) through a subformula
    closed set \Sigma, then \(\fM^f\) contains at most \(2^n\) nodes (where \(n\)
    denotes the size of \Sigma)
    #+END_proposition

    #+BEGIN_proof
    The states of \(\fM^f\) are the equivalence classes in \(W_\Sigma\). Let
    \(g\) be the function with domain \(W_\Sigma\) and range \(\calp(\Sigma)\)
    defined by \(g(\abs{w})=\{\phi\in\Sigma\mid\fM,w\Vdash\phi\}\). It follows
    from the definition of \(\leftrightsquigarrow_\Sigma\) that \(g\) is well
    defined and injective. Thus \(\abs{W_\Sigma}\le 2^n,n=\abs{\Sigma}\)
    #+END_proof

    #+ATTR_LATEX: :options [Filtration Theorem]
    #+BEGIN_theorem
    Consider the basic modal language. Let \(\fM^f=(W_\Sigma,R^f,V^f)\) be a
    filtration of \(\fM\) through a subformula closed set \Sigma. Then for all
    formulas \(\phi\in\Sigma\), and all nodes \(w\) in \(\fM\), we have
    \(\fM,w\Vdash\phi\) iff \(\fM^f,\abs{w}\Vdash\phi\)
    #+END_theorem

    #+BEGIN_proof
    Suppose \(\diamond\phi\in\Sigma\) and \(\fM,w\Vdash\diamond\phi\). Then there
    is a \(v\) s.t. \(Rwv\) and \(\fM,v\Vdash\phi\). As \(\fM^f\) is a
    filtration, \(R^f\abs{w}\abs{v}\). As \Sigma is a subformula closed,
    \(\phi\in\Sigma\), thus by the inductive hypothesis
    \(\fM^f,\abs{v}\Vdash\phi\). Hence \(\fM^f,\abs\Vdash\diamond\phi\)

    Suppose \(\diamond\phi\in\Sigma\) and \(\fM^f,\abs{w}\Vdash\diamond\phi\).
    Thus there is a state \(\abs{v}\) in \(\fM^f\) s.t. \(R^f\abs{w}\abs{v}\)
    and \(\fM^f,\abs{v}\Vdash\phi\). As \(\phi\in\Sigma\), we have
    \(\fM,v\Vdash\phi\). By the definition, we have \(\fM,w\Vdash\diamond\phi\)
    #+END_proof

    Note that clauses 2 and 3 of Definition ref:def2.36 are designed to make the
    modal case of the inductive step go through.

    Define
    1. \(R^s\abs{w}\abs{v}\) iff \(\exists w'\in\abs{w}\exists v'\in\abs{v}Rw'v'\)
    2. \(R^l\abs{w}\abs{v}\) iff for all formulas \(\diamond\phi\in\Sigma\):
       \(\fM,v\Vdash\phi\) implies \(\fM,w\Vdash\diamond\phi\)


    These relations give rise to the *smallest* and *largest* filtrations respectively

    #+ATTR_LATEX: :options []
    #+BEGIN_lemma
    Consider the basic modal language. Let \(\fM\) be any model, \Sigma any
    subformula closed set of formulas, \(W_\Sigma\) the set of equivalence
    classes induced by \(\leftrightsquigarrow_\Sigma\), and \(V^f\) the standard
    valuation on \(W_\Sigma\). Then both \((W_\Sigma,R^s,V^f)\) and
    \((W_\Sigma,R^l,V^f)\) are filtrations of \(\fM\) through \Sigma. Furthermore, if
    \((W_\Sigma, R^f,V^f)\) is any filtration of \(\fM\) through \Sigma, then
    \(R^s\subseteq R^f\subseteq R^l\)
    #+END_lemma

    #+BEGIN_proof
    If \(Rwv\), if \(\fM,v\Vdash\phi\), then \(\fM,w\Vdash\diamond\phi\), hence
    \(R^l\abs{w}\abs{v}\)

    For any \((W_\Sigma,R^f,V^f)\). \(R^s\subseteq R^f\) by clause 2.
    \(R^f\subseteq R^l\) by clause 2
    #+END_proof

    #+ATTR_LATEX: :options [Finite Model Property - via Filtrations]
    #+BEGIN_theorem
    Let \phi be a basic modal formula. if \phi is satisfiable, then it is satisfiable
    on a finite model. Indeed, it is satisfiable on a finite model containing at
    most \(2^m\) nodes, where \(m\) is the number of subformulas of \phi
    #+END_theorem

    #+BEGIN_proof
    Assume that \phi is satisfiable on a model \(\fM\); take any filtration of
    \(\fM\) through the set of subformulas .
    #+END_proof

    #+ATTR_LATEX: :options []
    #+BEGIN_lemma
    Let \(\fM\) be a model, \Sigma a subformula closed set of formulas, and
    \(W_\Sigma\) the set of equivalence classes induced on \(\fM\) by
    \(\leftrightsquigarrow_\Sigma\). Let \(R^t\) be the binary relation on
    \(W_\Sigma\) defined by
    \begin{equation*}
    R^t\abs{w}\abs{v} \text{ iff for all }\phi, \text{ if }\diamond\phi\in\Sigma
    \text{ and }\fM,v\Vdash\phi\vee\diamond\phi\text{ then }\fM,w\Vdash\diamond\phi
    \end{equation*}
    If \(R\) is transitive then \((W_\Sigma,R^t,V^f)\) is a filtration and
    \(R^t\) is transitive
    #+END_lemma

    #+ATTR_LATEX: :options []
    #+BEGIN_definition
    Let \((W,R,V)\) be a transitive frame. A *cluster* on \((W,R,V)\) is a
    maximal, nonempty equivalence class under \(R\). That is, \(C\subseteq W\)
    is a cluster if the restriction of \(R\) to \(C\) is an equivalence relation

    A cluster is *simple* if it consists of a single reflexive point, and *proper*
    if it consists more than one point
    #+END_definition
** The Standard Translation
   #+ATTR_LATEX: :options []
   #+BEGIN_definition
   For \tau a modal similarity type and \Phi a collection of proposition letters, let
   \(\call_\tau^1(\Phi)\) be the first-order language (with equality) which has
   unary predicates \(P_0,P_1,\dots\) corresponding to the proposition letters
   \(p_0,p_1,\dots\) in \Phi, and an \((n+1)\)-ary relation symbol \(R_{\triangle}\)
   for each (\(n\)-ary) modal operator \(\triangle\) in our similarity type. We
   write \(\alpha(x)\) to denote a first-order formula \alpha with one free variable, \(x\)
   #+END_definition

   #+ATTR_LATEX: :options [Standard Translation]
   #+BEGIN_definition
   Let \(x\) be a first-order variable. The *standard translation* \(ST_x\) taking
   modal formulas to first-order formulas in \(\call_\tau^1(\Phi)\) is defined as
   \begin{align*}
   ST_x(p)&\quad\text{=}\quad Px\\
   ST_x(\bot)&\quad\text{=}\quad x\neq x\\
   ST_x(\neg\phi)&\quad\text{=}\quad \neg ST_x(\phi)\\
   ST_x(\phi\vee\psi)&\quad\text{=}\quad ST_x(\phi)\vee ST_x(\psi)\\
   ST_x(\triangle(\phi_1,\dots,\phi_n))&\quad\text{=}\quad \exists y_1\dots
   \exists y_n(R_{\triangle} xy_1\dots y_n\wedge\\
   &\hspace{2cm}ST_{y_1}(\phi_1)\wedge\dots\wedge ST_{y_n}(\phi_n) )
   \end{align*}
   where \(y_1,\dots,y_n\) are fresh variables.
   #+END_definition

   \begin{gather*}
   ST_x(\diamond\phi)=\exists y(Rxy\wedge ST_y(\phi))\\
   ST_x(\Box\phi)=\forall y(Rxy\to ST_y(\phi))
   \end{gather*}

   #+ATTR_LATEX: :options [Local and Global Correspondence on Models]
   #+BEGIN_proposition
   label:prop2.47
   Fix a modal similarity type \tau, and let \phi be a \(\tau\)-formula. Then
   1. For all \(\fM\) and all states \(w\) of \(\fM\): \(\fM,w\Vdash \phi\) iff
      \(\fM\models ST_x(\phi)[w]\)
   2. For all \(\fM\): \(\fM\Vdash\phi\) iff \(\fM\models\forall x ST_x(\phi)\)
   #+END_proposition

   #+ATTR_LATEX: :options []
   #+BEGIN_proposition
   1. Let \tau be a modal similarity type that only contains diamonds. Then, every
      \(\tau\)-formula \phi is equivalent to a first-order formula containing at
      most two variables
   2. If \tau does not contain modal operators \(\triangle\) whose arity exceeds
      \(n\), all \(\tau\)-formulas are equivalent to first-order formulas
      containing at most \((n+1)\) vairables
   #+END_proposition

   #+BEGIN_proof
   Assume \tau contains only diamonds \(\la a\ra,\la b\ra\). Fix two distinct
   variables \(x\) and \(y\). Define two variants \(ST_x\) and \(ST_y\) of the
   standard translation as follows
   \begin{alignat*}{2}
   &ST_x(p)=Px&&ST_y(p)=Py\\
   &ST_x(\bot)=x\neq x\quad&&ST_y(\bot)=y\neq y\\
   &ST_x(\neg\phi)=\neg ST_x(\phi)&&ST_y(\neg\phi)=\neg ST_y(\phi)\\
   &ST_x(\phi\vee\psi)=ST_x(\phi)\vee ST_x(\psi)&&ST_y(\phi\vee\psi)=ST_y(\phi)\vee ST_y(\psi)\\
   &ST_x(\la a\ra\phi)=\exists y(R_axy\wedge ST_y(\phi))\quad&&
   ST_y(\la a\ra\phi)=\exists x(R_ayx\wedge ST_x(\phi))
   \end{alignat*}
   Then for any \(\tau\)-formula \phi, its \(ST_x\)-translation contains at most
   the two variables \(x\) and \(y\), and \(ST_x(\phi)\) is equivalent to the
   original standard translation of \phi
   #+END_proof

   #+ATTR_LATEX: :options []
   #+BEGIN_examplle
   \begin{align*}
   ST_x(\diamond(\Box p\to q))&=
   \exists y(Rxy\wedge ST_y(\Box p\to q))\\
   &=\exists y(Rxy\wedge(\forall x(Ryx\to ST_x(p))\to Qy))\\
   &=\exists y(Rxy\wedge(\forall x(Ryx\to Px)\to Qy))
   \end{align*}
   #+END_examplle

   \(Rxx\) is not equivalent to any modal formula. Suppose \phi is a modal formula
   s.t. \(ST_x(\phi)\) is equivalent to \(Rxx\). Let \(\fM\) be a singleton
   reflexive model and let \(w\) be the unique state in \(\fM\); obviously
   \(\fM\models Rxx[w]\). Let \(\fN\) be a model based on the strict ordering of
   the integers; for every integer \(v\), \(\fN\models\neg Rxx[v]\). Let \(Z\)
   be the relation which links every integer with the unique state in \(fM\),
   and assume that the valuations in \(\fN\) and \(\fM\) are s.t. \(Z\) is a
   bisimulation.
   \begin{equation*}
   \fM\models Rxx[w]\Rightarrow\fM,w\Vdash\phi\Rightarrow\fN,v\Vdash\phi
   \Rightarrow\fN\models Rxx[v]
   \end{equation*}

   #+ATTR_LATEX: :options []
   #+BEGIN_definition
   Let \tau be a modal similarity type, \(\sfC\) a class of \(\tau\)-models, and \Gamma
   a set of formulas over \tau. We say that \Gamma *defines* of *characterizes* a class
   \(\sfK\) of models *within* \(\sfC\) if for all models \(\fM\) in \(\sfC\) we
   have that \(\fM\) is in \(\sfK\) iff \(\fM\Vdash\Gamma\). If \(\sfC\) is the
   class of all \(\tau\)-models, we simply say that \Gamma defines or characterizes
   \(\sfK\); we omit brackets whenever \Gamma is a singleton. We say that a formula \phi
   defines a *property* whenever \phi defines the class of models satisfying the property
   #+END_definition
** Modal Saturation via Ultrafilter Extensions
*** M-saturation
    #+ATTR_LATEX: :options [Hennessy-Milner Classes]
    #+BEGIN_definition
    Let \tau be a modal similarity type, and \(\sfK\) a class of \(\tau\)-models.
    \(\sfK\) is a *Hennessy-Milner* class, or *has the Hennessy-Milner property*, if
    for every two models \(\fM\) and \(\fM'\) in \(\sfK\) and any two states
    \(w,w'\) of \(\fM\) and \(\fM'\), respectively, \(w\leftrightsquigarrow w'\)
    implies \(\fM,w\leftrightarroweq \fM',w'\)
    #+END_definition

    For example, by Theorem ref:thm2.24 the class of image-finite models has the
    Hennessy-Milner property.

    Suppose we are working in the basic modal language. Let \(\fM=(W,R,V)\) be a
    model, let \(w\) be a state in \(W\) and let
    \(\Sigma=\{\phi_0,\phi_1,\dots\}\) be an infinite set of formulas. Suppose
    that \(w\) has successors \(v_0,v_1,\dots,\) where respectively
    \(\phi_0,\phi_0\wedge\phi_1,\phi_0\wedge\phi_1\wedge\phi_2,\dots\) hold. If
    there is no successor \(v\) of \(w\) where *all* formulas from \Sigma hold *at the
    same time*, then the model is in some sense incomplete. A model is called
    m-saturated if incompleteness of this kind does not occur

    Suppose that we are looking for a successor of \(w\) at which every formula
    \(\phi_i\) of the infinite set of formulas
    \(\Sigma=\{\phi_0,\phi_1,\dots\}\) holds. M-saturation is a kind of
    compactness property, according to which it suffices to find satisfying
    successors of \(w\) for arbitrary finite approximations of \Sigma

    #+ATTR_LATEX: :options [M-saturation]
    #+BEGIN_definition
    Let \(\fM=(W,R,V)\) be a model of the basic modal similarity type, \(X\) a
    subset of \(W\) and \Sigma a set of modal formulas. \Sigma is *satisfiable* in the set
    \(X\) if there is a state \(x\in X\) s.t. \(\fM,x\Vdash\phi\) for all
    \(\phi\in\Sigma\). \Sigma is *finitely satisfiable* in \(X\) if every finite subset
    of \Sigma is satisfiable in \(X\)

    The model \(\fM\) is called *\(m\)-saturated* if it satisfies the following
    condition for every state \(w\in W\) and every set \Sigma of modal formulas:

    \begin{center}
    If \(\Sigma\) is finitely satisfiable in the set of successors of \(w\), \par
    then
    \(\Sigma\) is satisfiable in the set of successors of \(w\)
    \end{center}

    Let \tau be a modal similarity type, and let \(\fM\) be a \(\tau\)-model.
    \(\fM\) is called *\(m\)-saturated* if for every state \(w\) of \(\fM\) and
    every (\(n\)-ary) modal operator \(\triangle\in\tau\) and sequence
    \(\Sigma_1,\dots,\Sigma_n\) of sets of modal formulas, we have the
    following:

    \begin{center}
        If for every sequence of finite subsets \(\Delta_1\subset\Sigma_1,\dots,\Delta_n
        \subseteq\Sigma_n\), there are states \(v_1,\dots,v_n\) s.t.
        \(Rwv_1\dots v_n\) and \(v_1\Vdash\Delta_1,\dots,v_n\Vdash\Delta_n\),\par
        then there are states \(v_1,\dots,v_n\) in \(\fM\) s.t. \(Rwv_1\dots v_n\) and
        \(v_1\Vdash\Sigma_1,\dots v_n\Vdash\Sigma_n\)
    \end{center}
    #+END_definition

    #+ATTR_LATEX: :options []
    #+BEGIN_proposition
    label:prop2.54
    Let \tau be a modal similarity type. Then the class of \(m\)-saturated
    \(\tau\)-models has the Hennessy-Milner property
    #+END_proposition

    #+BEGIN_proof
    Let \(\fM=(W,R,V)\)  and \(\fM'=(W',R',V')\) be two m-saturated models.

    Assume that \(w,v\in W\) and \(w'\in W'\) are s.t. \(Rwv\) and
    \(w\leftrightsquigarrow w'\). Let \Sigma be the set of formulas true at \(v\). It
    is clear that for every finite subset \Delta of \Sigma we have
    \(\fM,v\Vdash\bigwedge\Delta\), hence
    \(\fM,w\Vdash\diamond\bigwedge\Delta\). As \(w\leftrightsquigarrow w'\), it
    follows that \(\fM',w'\Vdash\diamond\bigwedge\Delta\), so \(w'\) has an
    \(R'\)-successor \(v_\Delta\) s.t. \(\fM',v_\Delta\Vdash\bigwedge\Delta\).
    In other words, \Sigma is finitely satisfiable in the set of successors of
    \(w'\); but then, by m-saturation, \Sigma itself is satisfiable in a successor
    \(v'\) of \(w'\). Thus \(v\leftrightsquigarrow v'\)
    #+END_proof
*** Ultrafilter extensions
    #+ATTR_LATEX: :options [Filters and Ultrafilters]
    #+BEGIN_definition
    Let \(W\) be a non-empty set. A *filter* \(F\) *over* \(W\) is a set
    \(F\subseteq\calp(W)\) s.t.
    1. \(W\in F\)
    2. If \(X,Y\in F\), then \(X\cap Y\in F\)
    3. If \(X\in F\) and \(X\subseteq Z\subseteq W\), then \(Z\in F\)


    An *ultrafilter over \(W\)* is a proper filter s.t. for all \(X\in\calp(W)\),
    \(X\in U\) iff \((W\setminus X)\in U\)
    #+END_definition

    #+ATTR_LATEX: :options []
    #+BEGIN_definition
    Let \(W\) be a non-empty set, and let \(E\) be a subset of \(\calp(W)\). By
    the *filter generated by* \(E\) we mean the intersection \(F\) of the
    collection of all filters over \(W\) which include \(E\)
    \begin{equation*}
    F=\bigcap\{G\mid E\subseteq G\text{ and $G$ is a filter over }W\}
    \end{equation*}
    \(E\) has the *finite intersection property* if the intersection of any finite
    number of elements of \(E\) is non-empty
    #+END_definition

    #+ATTR_LATEX: :options [Zorn's Lemma]
    #+BEGIN_lemma
    Whenever \(<\) is a strict partial order of a set \(A\) satisfying for all
    chains \(C\subseteq A\) there is some \(b\in A\) s.t. \(x\le b\) for all
    \(x\in C\) then for all \(a\in A\), there is a maximal \(b\in A\) with
    \(b\ge a\)
    #+END_lemma

    #+ATTR_LATEX: :options [Ultrafilter Theorem]
    #+BEGIN_theorem
    Fix a non-empty set \(W\). Any proper filter over \(W\) can be extended to
    an ultrafilter over \(W\). As a corollary, any subset of \(\calp(W)\) with
    the finite intersection property can be extended to an ultrafilter over \(W\)
    #+END_theorem

    #+ATTR_LATEX: :options []
    #+BEGIN_definition
    Let \(W\) be a non-empty set. Given an element \(w\in  W\), the *principal
    ultrafilter* \(\pi_w\) generated by \(w\) is the filter generated by the
    singleton set \(\{w\}\)
    #+END_definition

    Suppose \(U\) is an ultrafilter over a non-empty set \(I\), and that for
    each \(i\in I\), \(A_i\) is a non-empty set. Let \(C=\prod_{i\in I}A_i\).
    That is, \(C\) is the set of all functions \(f\) with domain \(I\) s.t. for
    each \(i\in I\), \(f(i)\in A_i\). For two functions \(f,g\in C\) we say that
    \(f\) and \(g\) are *\(U\)-equivalent* (\(f\sim_U g\)) if \(\{i\in I\mid
    f(i)=g(i)\}\in U\)

    #+ATTR_LATEX: :options []
    #+BEGIN_proposition
    The relation \(\sim_U\) is an equivalence relation on the set \(C\)
    #+END_proposition

    #+BEGIN_proof
    Suppose \(\{i\mid f(i)=g(i)\}\in U,\{i\mid g(i)=h(i)\}\in U\), then
    \(\{i\mid f(i)=g(i)=h(i)\}=\{i\mid f(i)=g(i)\}\cap\{i\mid g(i)=h(i)\}\in
    U\). And
    \(\{i\mid f(i)=g(i)=h(i)\}\subseteq\{i\mid f(i)=h(i)\}\)
    #+END_proof

    #+ATTR_LATEX: :options []
    #+BEGIN_definition
    Let \(f_U\) be the equivalence class of \(f\) modulo \(\sim_U\), that is:
    \(f_U=\{g\in C\mid g\sim_U f\}\). The *ultraproduct of* the sets \(A_i\)
    *modulo* \(U\) is the set of all equivalence classes of \(\sim_U\). It is
    denoted by \(\prod_UA_i\). So
    \begin{equation*}
    \prod_UA_i=\{f_U\mid f\in\prod_{i\in I}A_i\}
    \end{equation*}
    #+END_definition

    #+ATTR_LATEX: :options []
    #+BEGIN_definition
    Fix a first-order language \(\call^1\), and let \(\fA_i(i\in I)\) be
    \(\call^1\)-models. The *ultraproduct* \(\prod_U\fA_i\) *of* \(\fA_i\) *modulo*
    \(U\) is the model described as follows:
    1. The universe \(A_U\) is the set \(\prod_UA_i\), where \(A_i\) is the
       universe of \(\fA_i\)
    2. Let \(R\) be an \(n\)-place relation symbol, and \(R_i\) its
       interpretation in the model \(\fA_i\). The relation \(R_U\) in
       \(\prod_U\fA_i\) is given by
       \begin{equation*}
       R_Uf_U^1\dots f_U^n \quad\text{ iff }\quad
       \{i\in I\mid R_if^1(i)\dots f^n(i)\}\in U
       \end{equation*}
    3. Let \(F\) be an \(n\)-place function symbol, and \(F_i\) its
       interpretation in \(\fA_i\). The function \(F_U\) in \(\prod_U\fA_i\) is
       given by
       \begin{equation*}
       F_U(f_U^1,\dots,f_U^n)=
       \{(i,F_i(f^1(i),\dots,f^n(i)))\mid i\in I\}_U
       \end{equation*}
    4. Let \(c\) be a constant, and \(a_i\) its interpretation in \(\fA_i\).
       Then \(c\) is interpreted by the element \(c'\in\prod_UA_i\) where
       \(c'=\{(i,a_i)\mid i\in I\}_U\)


    In the case where all the structures are the same, say \(\fA_i=\fA\) for all
    \(i\), we speak of the *ultrapower* of \(\fA\)  modulo \(U\), notation \(\prod_U\fA\)
    #+END_definition

    #+ATTR_LATEX: :options [Łoś's Theorem]
    #+BEGIN_theorem
    label:thmA.19
    Let \(U\) be an ultrafilter over a non-empty set \(I\). For each \(i\in I\),
    let \(\fA_i\) be a model
    1. For every term \(t(x_1,\dots,x_n)\) and all elements
       \(f_U^1,\dots,f_U^n\) of \(\fB=\prod_U\fA_i\) we have
       \begin{equation*}
       t^{\fB}[x_1\mapsto f_U^1,\dots,x_n\mapsto f_U^n]=
       \{(i,t^{\fA_i}[f^1(i),\dots,f^n(i)])\mid i\in I\}_U
       \end{equation*}
    2. Given any first-order formula \(\alpha(x_1,\dots,x_n)\) in \(\call_\tau^1\)
       and \(f_U^1,\dots,f_U^n\) in \(\prod_U\fA_i\) we have
       \begin{equation*}
       \prod_U\fA_i\models\alpha[f_U^1,\dots,f_U^n]
       \quad\text{ iff }\quad
       \{i\in I\mid\fA_i\models\alpha[f^1(i),\dots,f^n(i)]\}\in U
       \end{equation*}
    #+END_theorem

    #+BEGIN_proof
    1.
    2. Induction on \alpha. The atomic case holds by definition. Suppose that
       \(\alpha\equiv\neg\beta(x_1,\dots,x_n)\), then
       \begin{align*}
       \prod_U\fA_i\models\alpha[f_U^1\dots f_U^n]&\quad\text{ iff }\quad
       \prod_U\fA_i\not\models\beta[f_U^1,\dots,f_U^n]\\
       &\quad\text{ iff }\quad
       \{i\in I\mid\fA_i\models\beta[f_U^1,\dots,f_U^n]\}\not\in U\\
       &\quad\text{ iff }\quad
       \{i\in I\mid\fA_i\not\models\beta[f^1(i),\dots,f^n(i)]\}\in U\\
       &\quad\text{ iff }\quad
       \{i\in I\mid\fA_i\models\alpha[f^1(i),\dots,f^n(i)]\}\in U
       \end{align*}
       The second equivalence follows from the inductive hypothesis, and the
       third from the fact that \(U\) is an ultrafilter

       Suppose that \(\alpha(x_1,\dots,x_n)\equiv\exists x_0\beta(x_0,\dots,x_n)\),
       then
       \begin{align}
       \prod_U\fA_i\models\alpha[f_U^1,\dots,f_U^n]&\quad\text{ iff }\quad
       \exists f_U^0\in\prod_U\fA_i,\prod_U\fA_i\models\beta[f_U^0,\dots,f_U^n]\nonumber\\
       &\quad\text{ iff }\quad
       \exists f_U^0\in\prod_U\fA_i,\{i\in I\mid\fA_i\models\beta[f^0(i),\dots,f^n(i)]\}\in U
       \label{eqA.2}
       \end{align}
       As \(\fA_i\models\beta[f^0(i),\dots,f^n(i)]\) implies
       \(\fA_i\models\alpha[f^1(i),\dots,f^n(i)]\), which means
       \begin{equation*}
       \{i\in I\mid\fA_i\models\beta[f^0(i),\dots,f^n(i)]\}\subseteq
       \{i\in I\mid\fA_i\models\alpha[f^1(i),\dots,f^n(i)]\}
       \end{equation*}
       Hence
       \begin{equation}
       \{i\in I\mid\fA_i\models\alpha[f^1(i),\dots,f^n(i)]\}\in U\label{eqA.3}
       \end{equation}
       Conversely, if eqref:eqA.3 holds, then we can select a function
       \(f^0\in\prod_{i\in I}A_i\) s.t. eqref:eqA.2 holds. So eqref:eqA.2 is
       equivalent to eqref:eqA.3
    #+END_proof

    #+ATTR_LATEX: :options []
    #+BEGIN_corollary
    label:corA.20
    Let \(\prod_U\fA\) be an ultrapower of \(\fA\). Then for all first-order
    sentences \alpha, \(\fA\models\alpha\) iff \(\prod_U\fA\models\alpha\)
    #+END_corollary

    There is a natural embedding of a model \(\fA\) in each of its ultrapowers.
    Define the *diagonal mapping* \(d\) of \(\fA\) into \(\prod_U\fA\) to be the
    function
    \begin{equation*}
    \alpha\mapsto(f_\alpha)_U,\text{ where }f_a(i)=a\text{ for all }i\in I
    \end{equation*}

    #+ATTR_LATEX: :options []
    #+BEGIN_corollary
    Let \(\prod_U\fA\) be an ultrapower of \(\fA\). Then the diagonal mapping of
    \(\fA\) into \(\prod_U\fA\) is an elementary embedding
    #+END_corollary

    #+BEGIN_proof
    \begin{align*}
    \prod_U\fA\models\alpha[d(a_1),\dots,d(a_n)]&\quad\text{ iff }\quad
    \{i\in I\mid\fA\models\alpha[a_1,\dots,a_n]\}\in U\\
    &\quad\text{ iff }\quad \fA\models\alpha[a_1,\dots,a_n]
    \end{align*}
    #+END_proof


    \(V(\phi)=\{w\mid \fM,w\Vdash\phi\}\)

    #+ATTR_LATEX: :options []
    #+BEGIN_definition
    Given an \((n+1)\)-ary relation \(R\) on a set \(W\), we define the
    following two \(n\)-ary operations \(m_R\) and \(l_R\) on the power set
    \(\calp(W)\) of \(W\):
    \begin{align*}
    m_R(X_1,\dots,X_n)&:=\{w\in W\mid\exists w_1,\dots,w_n
    (Rww_1\dots w_n\bigwedge\forall i(w_i\in X_i))\}\\
    l_R(X_1,\dots,X_n)&:=\{w\in W\mid\forall w_1,\dots,w_n
    (Rww_1\dots w_n\to\exists i(w_i\in X_i))\}\\
    m_R(V(\phi_1),\dots,V(\phi_n))&:=V(\triangle(\phi_1,\dots,\phi_n))\\
    l_R(V(\phi_1),\dots,V(\phi_n))&:=V(\triangledown(\phi_1,\dots,\phi_n))
    \end{align*}
    #+END_definition

    It follows that for any  model \(\fM=(W,R,V)\) we have
    \begin{equation*}
    V(\diamond\phi)=m_R(V(\phi))\quad\text{ and }\quad
    V(\Box\phi)=l_R(V(\phi))
    \end{equation*}

    #+ATTR_LATEX: :options []
    #+BEGIN_proposition
    Let \(R\) be a relation of arity \(n+1\) on the set \(W\). Then for every
    \(n\)-tuple \(X_1,\dots,X_n\) of subsets of \(W\) we have
    \begin{equation*}
    l_R(X_1,\dots,X_n)=W\setminus m_R(W\setminus X_1,\dots,W\setminus X_n)
    \end{equation*}
    #+END_proposition

    #+BEGIN_proof
    This is actually \(\triangledown=\neg\triangle\neg\)
    \begin{align*}
    W\setminus m_R(W\setminus X_1,\dots,W\setminus X_n)&=
    \{w\mid\neg\exists w_1,\dots,w_n(Rww_1\dots w_n\bigwedge\forall i(w_i\in W\setminus X_i))\}\\
    &=\{\forall w_1,\dots,w_n(\neg Rww_1\dots w_n\bigvee\neg\forall i(w_i\in W\setminus X_i))\}\\
    &=\{\forall w_1,\dots,w_n(Rww_1\dots w_n\to\exists i(w_i\not\in W\setminus X_i))\}\\
    &=l_R(X_1,\dots,X_n)
    \end{align*}
    #+END_proof
    #+ATTR_LATEX: :options [Ultrafilter Extension]
    #+BEGIN_definition
    Let \tau be a modal similarity type, and
    \(\fF=(W,R_{\triangle})_{ \triangle\in\tau}\) is a \(\tau\)-frame. The
    *ultrafilter extension* \(\fu\fe\fF\) of \(\fF\) is defined as the frame
    \((Uf(W),R_{\triangle}^{ue})_{\triangle\in\tau}\). Here \(Uf(W)\) is the set of
    ultrafilters over \(W\) and \(R_{\triangle}^{ue}u_0u_1\dots u_n\) holds for
    a tuple \(u_0,\dots,u_n\) of ultrafilters over \(W\) if we have that
    \(m_{R_{\triangle}}(X_1,\dots,X_n)\in u_0\) whenever \(X_i\in u_i\) for all
    \(i\) with \(1\le i\le n\)

    The *ultrafilter extension* of a \(\tau\)-model \(\fM=(\fF,V)\) is the model
    \(\fu\fe\fM=(\fu\fe\fF,V^{ue})\) where \(V^{ue}(p_i)\) is the set of
    ultrafilters of which \(V(p_i)\) is a member
    #+END_definition

    Any subset of a frame can be viewed as a *proposition*. A filter over the
    universe of the frame can thus be seen as a *theory*, in fact as a logically
    closed theory, since filters are both closed under intersection
    (conjunction) and upward closed (entailment). Viewed this way, a proper
    filter is a *consistent* theory, or *state of affairs*,
    for it does not contain the empty set (falsum).
    Finally an ultrafilter is a *complete* theory.

    In a given frame \(\fF\) not every state not every state of affairs needs to
    'realized', in the sense that there is a state satisfying all and only the
    propositions belonging to the state of affairs; only the states of affairs
    that correspond to the *principal* ultrafilters are realized. We build
    \(\ue\fF\) by adding every state of affairs for \(\fF\) as a new element of
    the domain - that is, \(\ue\fF\) realizes every proposition in \(\fF\)

    Stipulate that \(R^{ue}_{\triangle}u_0u_1\dots u_n\) if \(u_0\) 'sees' the
    \(n\)-tuple \(u_1,\dots,u_n\). That is, whenever \(X_1,\dots,X_n\) are
    propositions of \(u_1,\dots, u_n\) respectively, then \(u_0\) 'sees' this
    combination: that is, the proposition \(m_{R_{\triangle}}(X_1,\dots,X_n)\)
    is a member of \(u_0\).

    *Principal* ultrafilters over \(W\) plays a special role. By identifying a
    state \(w\) of a frame \(\fF\) with the principal ultrafilter
    \(\pi_w=\{X\subset W\mid w\in X\}\), it
    is easily seen that any frame \(\fF\) is (isomorphic to) a *submodel* (but in
    general not a *generated* submodel) of its ultrafilter extension. For we have
    the following equivalences
    \begin{align*}
    Rwv &\quad\text{ iff }\quad
    w\in m_R(X)\text{ for all }X\subseteq W\text{ s.t. }v\in X\\
    &\quad\text{ iff }\quad
    m_R(X)\in\pi_w\text{ for all }X\subseteq W\text{ s.t. }X\in\pi_v\\
    &\quad\text{ iff }\quad R^{ue}\pi_w\pi_v
    \end{align*}
    since
    \begin{equation*}
    Rwv \quad\text{ iff }\quad
    \forall X\subseteq W(v\in X\to w\in m_R(X))
    \end{equation*}

    #+ATTR_LATEX: :options []
    #+BEGIN_examplle
    label:example2.58
    Consider the frame \(\fN=(\N,<)\)
    \begin{center}
        \begin{tikzpicture}
    [n/.style={circle,fill=black,inner sep=0pt,minimum size=1mm}]
    \node[n] (0) at (0,0) {};
    \node[n] (1) at (1,0) {};
    \node[n] (2) at (2,0) {};
    \node[n] (3) at (3,0) {};
    \node[n] (4) at (4,0) {};
    \node (5) at (5,0) {};
    \node[black,above] at (0.north) {$0$};
    \node[black,above] at (1.north) {$1$};
    \node[black,above] at (2.north) {$2$};
    \node[black,above] at (3.north) {$3$};
    \node[black,above] at (4.north) {$4$};
    \node[black,right] at (5.east) {$\cdots$};
    \draw[->] (0) -- (1);
    \draw[->] (1) -- (2);
    \draw[->] (2) -- (3);
    \draw[->] (3) -- (4);\iffalse<<<<\fi
    \draw[->] (4) -- (5);
    \end{tikzpicture}
    \end{center}
    What is the ultrafilter extension of \(\fN\)? There are two kinds of
    ultrafilter over an infinite set: the principal ultrafilter that are in
    one-to-one correspondence with the points of the set, and the non-principal
    ones which contain all co-finite sets and only infinite sets, cf Exercise
    ref:ex2.5.4. The principal ultrafilters form an isomorphic copy of the frame
    \(\fN\) inside \(\ue\fN\). For any pair \(u,u'\) of ultrafilters, if \(u'\)
    is non-principal, then \(R^{ue}uu'\). To set this, let \(X\in u'\). As
    \(X\) is infinite, for any \(n\in\N\) there is an \(m\) s.t. \(n<m\) and
    \(m\in X\). This show that \(m_<(X)=\N\). But \(\N\) is an element of every
    ultrafilter

    The shows that the ultrafilter extension of \(\fN\) consists of a copy of
    \(\fN\) followed by a uncountable cluster consisting of all the
    non-principal ultrafilters
    #+END_examplle

    #+ATTR_LATEX: :options []
    #+BEGIN_proposition
    label:prop2.59
    Let \tau be a modal similarity type, and \(\fM\) a \(\tau\)-model. Then for any
    formula \phi and any ultrafilter \(u\) over \(W\), \(V(\phi)\in u\) iff
    \(\ue\fM,u\models\phi\). Hence for every state \(w\) of \(\fM\) we have
    \(w\leftrightsquigarrow \pi_w\)
    #+END_proposition

    #+BEGIN_proof
    The second claim of the proposition is immediate from the first one by the
    observation that \(w\Vdash\phi\) iff \(w\in V(\phi)\) iff \(V(\phi)\in\pi_w\)

    Induction on \phi. The basic case is immediate from the definition of
    \(V^{ue}\). Suppose \phi is of the form \(\neg\psi\), then
    \begin{align*}
    V(\neg\psi)\in u&\quad\text{ iff }\quad
    W\setminus V(\psi)\in u\\
    &\quad\text{ iff }\quad V(\psi)\not\in u\\
    &\quad\text{ iff }\quad \ue\fM,u\not\Vdash\psi\quad\text{IH}\\
    &\quad\text{ iff }\quad \ue\fM,u\Vdash\neg\psi
    \end{align*}

    Now consider the case where \phi is of the form \(\diamond\psi\). Assume first
    that \(\ue\fM,u\Vdash\diamond\psi\). Then there is an ultrafilter \(u'\)
    s.t. \(R^{ue}uu'\) and \(\ue\fM,u'\Vdash\psi\). The induction hypothesis
    implies that \(V(\psi)\in u'\), so by the definition of \(R^{ue}\),
    \(m_R(V(\psi))\in u\). Now the result follows immediately from the observation
    that \(m_R(V(\psi))=V(\diamond\psi)\)

    Assume that \(V(\diamond\psi)\in u\). We have to find an ultrafilter \(u'\)
    s.t. \(V(\psi)\in u'\) and \(R^{ue}uu'\). The latter constraint reduces to the
    condition that \(m_R(X)\in u\) whenever \(X\in u'\), or equivalently (see
    Exercise ref:ex2.5.5)
    \begin{equation*}
    u_0':=\{Y\mid l_R(Y)\in u\}\subseteq u'
    \end{equation*}
    We will first show that \(u_0'\) is closed under intersection. Let \(Y,Z\in
    u_0'\). By definition, \(l_R(Y)\) and \(l_R(Z)\) are in \(u\). But then
    \(l_R(Y\cap Z)\in u\) as \(l_R(Y\cap Z)=l_R(Y)\cap l_R(Z)\). This proves
    that \(Y\cap Z\in u_0'\)

    Next we make sure that for any \(Y\in u_0'\), \(Y\cap V(\psi)\neq\emptyset\).
    Let \(Y\) be an arbitrary element of \(u_0'\), then by definition of
    \(u_0'\), \(l_R(Y)\in u\). As \(u\) is closed under intersection and does
    not contain the empty set, there must be an element \(x\in l_R(Y)\cap
    V(\diamond\psi)\). But then \(x\) must have a successor \(y\) in \(V(\psi)\).
    Finally, \(x\in l_R(Y)\) implies \(y\in Y\)

    From the fact that \(u_0'\) is closed under intersection, and the fact that
    for any \(Y\in u_0'\), \(Y\cap V(\psi)\neq\emptyset\), it follows that the set
    \(u_0'\cup\{V(\psi)\}\) has the finite intersection property. So the
    Ultrafilter Theorem provides us with an ultrafilter \(u'\) s.t.
    \(u_0'\cup\{V(\psi)\}\subseteq u'\). This ultrafilter \(u'\) has the desired
    properties: it is clearly a successor of \(u\), and the fact the
    \(\ue\fM,u'\Vdash\psi\) follows from \(V(\psi)\in u'\) and the induction hypothesis
    #+END_proof

    #+ATTR_LATEX: :options []
    #+BEGIN_examplle
    Our new invariance result can be used to compare the relative expressive
    power of modal languages. Consider the modal constant
    \(\acwopencirclearrow\) whose truth definition in a model for the basic
    modal language is
    \begin{equation*}
    \fM,w\Vdash\acwopencirclearrow \quad\text{ iff }\quad
    \fM\models Rxx[v]\text{ for some $v$ in }\fM
    \end{equation*}
    Comparing the pictures of the frame \((\N,<)\) and its ultrafilter extension
    given in Example ref:example2.58 . The former is loop-free but the latter
    contains uncountably many loops
    #+END_examplle

    #+ATTR_LATEX: :options []
    #+BEGIN_proposition
    label:prop2.61
    Let \tau be a modal similarity type, and let \(\fM\) be a \(\tau\)-model. Then
    \(\ue\fM\) is \(m\)-saturated
    #+END_proposition

    #+BEGIN_proof
    Let \(\fM=(W,R,V)\) be a model. Consider an ultrafilter \(u\) over \(W\),
    and a set \Sigma of modal formulas which is finitely satisfiable in the set of
    successors of \(u\). We have to find an ultrafilter \(u'\) s.t.
    \(R^{ue}uu'\) and \(\ue\fM,u'\Vdash\Sigma\). Define
    \begin{equation*}
    \Delta=\{V(\phi)\mid\phi\in\Sigma'\}\cup\{Y\mid l_R(Y)\in u\}
    \end{equation*}
    where \(\Sigma'\) is the set of (finite) conjunctions of formulas in \Sigma. We
    claim that the set \Delta has the finite intersection property. Since both
    \(\{V(\phi)\mid\phi\in\Sigma'\}\) and \(\{Y\mid l_R(Y)\in u\}\) are closed
    under taking intersections, it suffices to prove that for an arbitrary
    \(\phi\in\Sigma'\) and an arbitrary set \(Y\subseteq W\) for which
    \(l_R(Y)\in u\), we have \(V(\phi)\cap Y\neq\emptyset\). but if
    \(\phi\in\Sigma'\), then by assumption, there is a successor \(u''\) of u
    s.t. \(\ue\fM,u''\Vdash\phi\), or in other words, \(V(\phi)\in u''\). Then
    \(l_R(Y)\in u\) implies \(Y\in u''\) by Exercise ref:ex2.5.5 . Hence
    \(V(\phi)\cap Y\) is an element of the ultrafilter \(u''\) and therefore cannot
    be identical to the empty set.

    It follows by the Ultrafilter Theorem that \Delta can be extended to an
    ultrafilter \(u'\). Clearly \(u'\) is the required successor
    #+END_proof

    #+ATTR_LATEX: :options []
    #+BEGIN_theorem
    Let \tau be a modal similarity type, and let \(\fM\) and \(\fM'\) be
    \(\tau\)-models, and \(w,w'\) two states in \(\fM\) and \(\fM'\) respectively.
    Then
    \begin{equation*}
    \fM,w\leftrightsquigarrow \fM',w' \quad\text{ iff }\quad
    \ue\fM,\pi_w\leftrightarroweq\ue\fM',\pi_{w'}
    \end{equation*}
    #+END_theorem

    #+BEGIN_proof
    From Propositions ref:prop2.59, ref:prop2.61 and ref:prop2.54
    #+END_proof


    #+BEGIN_exercise
    label:ex2.5.4
    Let \(W\) be an infinite set. Recall that \(X\subseteq W\) is *co-finite* if
    \(W\setminus X\) is finite
    1. Prove that the collection of co-finite subsets of \(W\) has the finite
       intersection property
    2. Show that there are ultrafilters over \(W\) that do not contain any
       finite set
    3. Prove that an ultrafilter is non-principal iff it contains only infinite
       sets iff it contains all co-finite sets
    4. Prove that any ultrafilter over \(W\) has uncountably many elements
    #+END_exercise

  

    #+BEGIN_proof
    Suppose \(U=\{X\subseteq W\mid X\text{ is cofinite}\}\)
    1. For any \(A,B\in U\), if \(A\cap B=\empty\), \(A\subset\bbar{B}\). But
       \(A\) is infinite and \(\bbar{B}\) is finite, this can't happen. Hence
       \(A\cap B\neq\emptyset\)
    2. \(U\) can be extended to a ultrafilter \(\calu\). If \(A\) is finite, then
       \(\bbar{A}\in U\subseteq\calu\). Hence \(\calu\) does not contain any
       finite set.
    3. \(1\to 2\).If an ultrafilter contains a finite set. Then its a principal ultrafilter
       generated on the intersection of all finite sets.

       \(2\to3\) and \(3\to1\) are obvious.
    4. Half of the \(\calp(W)\) belongs to the ultrafilter and \(\calp(W)\) is uncountable
    #+END_proof

    #+BEGIN_exercise
    label:ex2.5.5
    Given a model \(\fM=(W,R,V)\) and two ultrafilters \(u\) and \(v\) over
    \(W\), show that \(R^{ue}uv\)iff \(\{Y\mid l_R(Y)\in u\}\subseteq v\)
    #+END_exercise

    #+BEGIN_proof
    \begin{align*}
    R^{ue}uv&\Leftrightarrow
    X\in v\to m_R(X)\in u\\
    &\Leftrightarrow \neg m_R(X)\in u\to \neg X\in v \\
    &\Leftrightarrow W-m_R(X)\in u\to W-X\in v\\
    &\Leftrightarrow l_R(W-X)\in u\to W-X\in v\\
    &(\text{Since }m_R(X)=W-l_R(W-X))\\
    &\Leftrightarrow\{Y\mid l_R(Y)\in u\}\subseteq v
    \end{align*}
    #+END_proof
** Characterization and Definability
*** The van Benthem Characterization Theorem
    Let \(\Gamma(x)\) be a set of first-order formulas in which a single individual
    variable may occur free - such a set of formulas is called a *type*. A
    first-order model \(\fM\) *realizes* \(\Gamma(x)\) if there is an element \(w\) in
    \(\fM\) s.t. for all \(\gamma\in\Gamma,\fM\models\gamma[w]\)

    Let \(\fM\) be a model for a given first-order language \(\call^1\) with
    domain \(W\). For a subset \(A\subset W\), \(\call^1[A]\) is the language
    obtained by extending \(\call^1\) with new constant \(\underline{a}\) for
    all elements \(a\in A\). \(\fM_A\) is the expansion of \(\fM\) to a
    structure for \(\call^1[A]\) in which each \(\underline{a}\) is interpreted
    as \(a\)

    Assume that \(A\) is of size at most \alpha. Assume that \(\alpha=3\) and
    \(A=\{\alpha_1,\alpha_2\}\). Let \(\Gamma(\und{a}_1,\und{a}_2,x)\) be a type of
    the language \(\call^1[A]\); \(\Gamma(\und{a}_1,\und{a}_2,x)\) is consistent with
    the first-order theory of \(\fM_A\) iff \(\Gamma(\und{a}_1,\und{a}_2,x)\) is
    finitely realizable in \(\fM_A\). So for this particular set
    \(\Gamma(\und{a}_1,\und{a}_2,x)\), 3-saturation of \(\fM\) means that if
    \(\Gamma(\und{a}_1,\und{a}_2,x)\) is finitely realizable in \(\fM_A\), then
    \(\Gamma(\und{a}_1,\und{a}_2,x)\) is realizable in \(\fM_A\)

    Or consider a formula \(\gamma(\und{a}_1,\und{a}_2,x)\) and let \(\gamma(x_1,x_2,x)\)
    be the formula with the fresh variables \(x_1\) and \(x_2\) replacing each
    occurrence in \gamma of \(\und{a}_1\) and \(\und{a}_2\) respectively. Then we
    have the following equivalence

    #+BEGIN_center
    \(\fM_A\) realizes \(\{\gamma(\und{a}_1,\und{a}_2,x)\}\) iff there is a \(b\)
    s.t. \(\fM\models\gamma(x_1,x_2,x)[a_1,a_2,b]\)
    #+END_center

    So a model is \(\alpha\)-saturated iff the following holds for every
    \(n<\alpha\) and every set \Gamma of formulas of the form \(\gamma(x_1,\dots,x_n,x)\)

    #+BEGIN_center
    *If* \((a_1,\dots,a_n)\) is an \(n\)-tuple s.t. for every finite
    \(\Delta\subseteq\Gamma\) there is a \(b_{\Delta}\) s.t.
    \(\fM\models\gamma(x_1,\dots,x_n,x)[a_1,\dots,a_n,b_\Delta]\) for every
    \(\gamma\in\Delta\)
    

    *then* we have that there is a \(b\) s.t.
     \(\fM\models\gamma(x_1,\dots,x_n,x)[a_1,\dots,a_n,b]\) for every \(\gamma\in\Gamma\)
    #+END_center


    #+ATTR_LATEX: :options []
    #+BEGIN_definition
    Let \alpha be a natural number, or \omega. A model \(\fM\) is *\(\alpha\)-saturated*
    if for  every subset \(A\subseteq W\) of size less than \alpha, the expansion
    \(\fM_A\) realizes every set \(\Gamma(x)\) of \(\call^1[A]\)-formulas (with only
    \(x\) occurring free) that is consistent with the first-order theory of
    \(\fM_A\). An \(\omega\)-saturated model is usually called *countably saturated*
    #+END_definition

    #+ATTR_LATEX: :options []
    #+BEGIN_examplle
    1. Every finite model is countably saturated. For if \(\fM\) is finite, and
       \(\Gamma(x)\) is a set of first-order formulas consistent with the first-order
       theory of \(\fM\), there exists a model \(\fN\) that is elementarily
       equivalent to \(\fM\) and that realizes \(\Gamma(x)\). But as \(\fM\) and
       \(\fN\) are finite, elementary equivalence implies isomorphism
       ([[https://math.stackexchange.com/questions/1518629/a-simple-proof-that-elementary-equivalence-and-isomorphism-coincide-for-finite-s][proof]])
       , and hence
       \(\Gamma(x)\) is realized in \(\fM\)
    2. The ordering of the rational numbers \((\Q,<)\) is countably saturated as
       well. The relevant first-order language \(\call^1\) has \(<\) and \(=\).
       Take a subset \(A\) of \(\Q\) and let \(\Gamma(x)\) be a set of formulas in the
       resulting expansion \(\call^1[A]\) of the first-order language that is
       consistent with the theory of \((\Q,<,a)_{a\in A}\). Then there exists a
       model \(\fN\) of the theory of \((\Q,<,a)_{a\in A}\) that realizes
       \(\Gamma(x)\). \(\star\).
       Now take a countable elementary submodel \(\fN'\) of \(\fN\) that
       contains at least one object realizing \(\Gamma(x)\). Then \(\fN'\) is a
       countable dense linear ordering without endpoints, and hence the ordering
       of \(\fN'\) is isomorphic to \((\Q,<)\).
    #+END_examplle

    #+ATTR_LATEX: :options []
    #+BEGIN_theorem
    label:thm2.65
    Let \tau be a modal similarity type. Any countably saturated \(\tau\)-model is
    \(m\)-saturated. It follows that the class of countably saturated
    \(\tau\)-models has the Hennessy-Milner property
    #+END_theorem

    #+BEGIN_proof
    Assume that \(\fM=(W,R,V)\) viewed as a first-order model, is countably
    saturated. Let \(a\) be a state in \(W\), and consider a set \Sigma of modal
    formulas which is finite satisfiable in the successor set of \(a\). Define
    \(\Sigma'\) to be the set
    \begin{equation*}
    \Sigma'=\{R\und{a}x\}\cup ST_x(\Sigma)
    \end{equation*}
    where \(ST_x(\Sigma)=\{ST_x(\phi)\mid\phi\in\Sigma\}\). \(\Sigma'\) is consistent
    with the first-order theory of \(\fM_a\): \(\fM_a\) realizes every finite
    subset of \(\Sigma'\), namely in some successor of \(a\). So by the
    countable saturation of \(\fM\), \(\Sigma'\) is realized in some state
    \(b\). By \(\fM_A\models R\und{a}x[b]\) it follows that \(b\) is a successor
    of \(a\). Then, by Proposition ref:prop2.47 and the fact that \(\fM_a\models
    ST_x(\phi)[b]\) for all \(\phi\in\Sigma\), it follows that
    \(\fM,b\Vdash\Sigma\). Thus \Sigma is satisfiable in a successor of \(a\)
    #+END_proof

    #+ATTR_LATEX: :options [Detour Lemma]
    #+BEGIN_lemma
    Let \tau be a modal similarity type, and let \(\fM\) and \(\fN\) be two models,
    and \(w\) and \(v\) states in \(\fM\) and \(\fN\), respectively. Then the
    following are equivalent:
    1. For all modal formulas \phi: \(\fM,w\Vdash\phi\) iff \(\fN,v\Vdash\phi\)
    2. There exists a bisimulation \(Z:\ue\fM,\pi_w\leftrightarroweq\ue\fN,\pi_v\)
    3. There exist countably saturated models \(\fM^*,w^*,\fN^*,v^*\) and elementary
       embeddings \(f:\fM\preceq\fM^*\) and \(g:\fN\preceq\fN^*\) s.t.
       1. \(f(w)=w^*\) and \(g(v)=v^*\)
       2. \(\fM^*,w^*\leftrightarroweq\fN^*,v^*\)
    #+END_lemma

    #+ATTR_LATEX: :options []
    #+BEGIN_definition
    A first-order formula \(\alpha(x)\) in \(\call^1_\tau\) is *invariant for
    bisimulations* if for all models \(\fM\) and \(\fN\), and all states \(w\) in
    \(\fM\), \(v\) in \(\fN\), and all bisimulations \(Z\) between \(\fM\) and
    \(\fN\) s.t. \(wZv\), we have \(\fM\models\alpha(x)[w]\) iff \(\fN\models\alpha(x)[v]\)
    #+END_definition

    #+ATTR_LATEX: :options [van Benthem Characterization Theorem]
    #+BEGIN_theorem
    Let \(\alpha(x)\) be a first-order formula in \(\call_\tau^1\). Then \(\alpha(x)\) is
    invariant for bisimulations iff it is equivalent to the standard translation
    of a modal \(\tau\)-formula
    #+END_theorem

    #+BEGIN_proof
    Assume \(\alpha(x)\) is invariant for bisimulations and consider the set of modal
    consequences of \alpha:
    \begin{equation*}
    MOC(\alpha)=\{ST_x(\phi)\mid\phi\text{ is a modal formula, and }\alpha(x)\models ST_x(\phi)\}
    \end{equation*}
    Our first claim is that if \(MOC(\alpha)\models\alpha(x)\), then \(\alpha\) is
    equivalent to the translation of a modal formula.  Assume
    \(MOC(\alpha)\models\alpha(x)\), then by the Compactness Theorem for first-order
    logic, for some finite subset \(X\subseteq MOC(\alpha)\), we have
    \(X\models\alpha(x)\). So \(\models\bigwedge X\to\alpha(x)\). Trivially
    \(\models\alpha(x)\to\bigwedge X\), thus
    \(\models\alpha(x)\leftrightarrow\bigwedge X\). And as every \(\beta\in X\)
    is the translation of a modal formula, so is \(\bigwedge X\)

    So it suffices to show that \(MOC(\alpha)\models\alpha(x)\). Assume
    \(\fM\models
    MOC(\alpha)[w]\); we need to show that \(\fM\models\alpha(x)[w]\). Let
    \begin{equation*}
    T(x)=\{ST_x(\phi)\mid\fM\models ST_x(\phi)[w]\}
    \end{equation*}
    We claim that \(T(x)\cup\{\alpha(x)\}\) is consistent. Assume that
    \(T(x)\cup\{\alpha(x)\}\) is inconsistent. Then by compactness, for some finite
    subset \(T_0(x)\subset T(x)\) we have \(\models\alpha(x)\to\neg\bigwedge
    T_x(x)\). Hence \(\neg\bigwedge T_0(x)\in MOC(\alpha)\). But this implies
    \(\fM\models\neg\bigwedge T_0(x)[w]\), a contradiction

    Let \(\fN,v\) be s.t. \(\fN\models T(x)\cup\{\alpha(x)\}[v]\). Observe that \(w\)
    and \(v\) are modally equivalent: \(\fM,w\Vdash\phi\) implies \(ST_x(\phi)\in
    T(x)\), which implies \(\fN,v\Vdash\phi\); and likewise, if
    \(\fM,w\not\Vdash\phi\) then \(\fM,w\Vdash\neg\phi\) and
    \(\fN,v\Vdash\neg\phi\).


    We can use the Detour Lemma and make a detour through a Hennessy-Milner
    class where modal equivalence and bisimilarity do coincide.
    \begin{tikzcd}
    \fM,w\arrow[d,dash,"\preceq"]&\fN,v\arrow[d,dash,"\preceq"]\\
    \fM^*,w^*\arrow[r,"\leftrightarroweq",dash]&\fN^*,v^*
    \end{tikzcd}
    \(\fN\model\alpha(x)[v]\) implies \(\fN^*\models\alpha(x)[v^*]\). As
    \(\alpha(x)\) is invariant for bisimulations, we get
    \(\fM^*\models\alpha(x)[w^*]\). By invariance under elementary embeddings,
    we have \(\fM\models\alpha(x)[w]\)
    #+END_proof


*** Ultraproducts

    Suppose \(I\neq\emptyset\), \(U\) is an ultrafilter over \(I\).
    #+ATTR_LATEX: :options [Ultraproducts of Sets]
    #+BEGIN_definition
    Let \(f_U\) be the equivalence class of \(f\) modulo \(\sim_U\), that is:
    \(f_U=\{g\in C\mid g\sim_U f}\). The *ultraproduct of \(W_i\) modulo* \(U\),
    denoted as \(\prod_UW_i\) is the set of all equivalence classes of
    \(\sim_U\). So
    \begin{equation*}
    \prod_UW_i=\{f_U\mid f\in\prod_{i\in I}W_i\}
    \end{equation*}
    In case \(W_i=W\), the ultraproduct is called the *ultrapower of \(W\) modulo*
    \(U\), and written \(\prod_UW\)
    #+END_definition

    #+ATTR_LATEX: :options [Ultraproduct of Models]
    #+BEGIN_definition
    Fix a modal similarity type \tau, and let \(\fM_i(i\in I)\) be \(\tau\)-models.
    The *ultraproduct* \(\prod_U\fM_i\) of \(\fM_i\) modulo \(U\) is the model
    described as follows
    1. The universe \(W_U\) of \(\prod_U\fM_i\) is the set \(\prod_UW_i\)
    2. Let \(V_i\) be the valuation of \(\fM_i\). Then the valuation \(V_U\) of
       \(\prod_U\fM_i\) is defined by
       \begin{equation*}
       f_U\in V_U(p) \quad\text{ iff }\quad
       \{i\in I\mid f(i)\in V_i(p)\}\in U
       \end{equation*}
    3. Let \(\triangle\) be a modal operator in \tau, and \(R_{\triangle i}\) its
       associated relation in the model \(\fM_i\). The relation \(R_{\triangle
       U}\) in \(\prod_U\fM_i\) is given by
       \begin{equation*}
       R_{\triangle U}f_U^1\dots f_U^{n+1} \quad\text{ iff }\quad
       \{i\in I\mid R_{\triangle i}f^1(i)\dots f^{n+1}(i)\}\in U
       \end{equation*}


    In particular,
    \begin{equation*}
    R_{\diamond U}f_Ug_U \quad\text{ iff }\quad
    \{i\in I\mid R_{\diamond i}f(i)g(i)\}\in U
    \end{equation*}
    #+END_definition

    #+ATTR_LATEX: :options []
    #+BEGIN_proposition
    Let \(\prod_U\fM\) be an ultrapower of \(\fM\). Then for al modal formulas \phi
    we have \(\fM,w\Vdash\phi\) iff \(\prod_U\fM,(f_w)_U\Vdash\phi\), where
    \(f_w\) is the constant function s.t. \(f_w(i)=w\) for all \(i\in I\)
    #+END_proposition

    #+BEGIN_proof
    1. \(\phi=p\)
       \begin{align*}
       \fM,w\Vdash\phi&\Leftrightarrow w\in V(\phi)\\&\Leftrightarrow
       \{i\in I\mid f_w(i)\in V(p)\}=I\in U\\&\Leftrightarrow
       \prod_U\fM,(f_w)_U\Vdash\phi
       \end{align*}
    2. \(\phi=\diamond\psi\)
       \begin{equation*}
       Rwv\Leftrightarrow\{i\in I\mid R_{\diamond i}f_w(i)f_v(i)\}=I\in U\Leftrightarrow
       R_{\diamond U}f_wg_v
       \end{equation*}
    #+END_proof

    An ultrafilter is *countably incomplete* if it is not closed under countably intersections

    #+ATTR_LATEX: :options []
    #+BEGIN_examplle
    Consider the set of natural numbers \(\N\). Let \(U\) be an ultrafilter over
    \(\N\) that does not contain any singletons \(\{u\}\). Then for all \(n\),
    \((\N\setminus\{n\})\in U\). But
    \begin{equation*}
    \emptyset=\bigcap_{n\in\N}(\N\setminus\{n\})\not\in U
    \end{equation*}
    So \(U\) is countably incomplete
    #+END_examplle

    #+ATTR_LATEX: :options []
    #+BEGIN_lemma
    label:lemma2.73
    Let \(\call\) be a countable first-order language, \(U\) a countably
    incomplete ultrafilter over a non-empty set \(I\), and \(\fM\) an
    \(\call\)-model. The ultrapower \(\prod_U\fM\) is countably saturated
    #+END_lemma

    #+ATTR_LATEX: :options []
    #+BEGIN_theorem
    label:thm2.74
    Let \tau be a modal similarity type, and let \(\fM\) and \(\fN\) be
    \(\tau\)-models, and \(w\) and \(v\) states in \(\fM\) and \(\fN\)
    respectively. Then the following are equivalent
    1. For all modal formulas \phi: \(\fM,w\Vdash\phi\) iff \(\fN,v\Vdash\phi\)
    2. There exists ultrapowers \(\prod_U\fM\) and \(\prod_U\fN\) as well as a
       bisimulation \(Z:\prod_U\fM,(f_w)_U\leftrightarroweq\prod_U\fN,(f_v)_U\)
       linking \((f_w)_U\) and \((f_v)_U\), where \(f_w(f_v)\) is the constant
       function mapping every index to \(w(v)\)
    #+END_theorem

    #+BEGIN_proof
    \(2\to1\). \(\fM,w\Vdash\phi_\) iff \(\prod_U\fM,(f_w)_U\Vdash\phi\) iff
    \(\prod_U\fN,(f_v)_U\Vdash\phi\) iff \(\fN,v\Vdash\phi\)

    \(1\to2\). Take \(\N\) as our index set, and let \(U\) be a countably
    incomplete ultrafilter over \(\N\). By Lemma ref:lemma2.73 the ultrapowers
    \(\prod_U\fM\) and \(\prod_U\fN\) are countably saturated. Now \((f_w)_U\)
    and \((f_v)_U\) are modally equivalence. Next apply Theorem ref:thm2.65: as
    \((f_w)_U\) and \((f_v)_U\) are modally equivalent and \(\prod_U\fM\) and
    \(\prod_U\fN\) are countably saturated, there exists a bisimulation
    #+END_proof

*** Definability
    Given a modal similarity type \tau, a pointed model is a pair \((\fM,w)\) where
    \(\fM\) is a \(\tau\)-model and \(w\) is a state of \(\fM\). A class of
    pointed models \(\sfK\) is said to be *closed under bisimulations* if
    \((\fM,w)\in\sfK\) and \(\fM,w\leftrightarroweq\fN,v\) implies
    \((\fN,v)\in\sfK\). \(\sfK\) is *closed under ultraproducts* if any
    ultraproducts \(\prod_U(\fM_i,w_i)\) of a family of pointed models
    \((\fM_i,w_i)\) in \(K\) belongs to \(\sfK\). If \(\sfK\) is a class of
    pointed \(\tau\)-models, \(\bbar{\sfK}\) denotes the complement of \(\sfK\)
    within the class of all pointed \(\tau\)-models. \(\sfK\) is
    *definable by a set of modal formulas* if there is a set of modal formulas \Gamma
    s.t. for any pointed model \((\fM,w)\) we have \((\fM,w)\) in \(\sfK\) iff
    for all \(\gamma\in\Gamma,\fM,w\Vdash\gamma\). \(\sfK\) is definable by a
    single modal formula iff it is definable by a singleton set

    By Theorem ref:thm2.20 definable classes of pointed models must be closed
    under bisimulations, and by Proposition ref:prop2.47 and Corollary
    ref:corA.20 they must be closed under ultraproducts as well.

    #+ATTR_LATEX: :options []
    #+BEGIN_theorem
    label:thm2.75
    Let \tau be a modal similarity type, and \(\sfK\) a class of pointed
    \(\tau\)-models. Then the following are equivalent:
    1. \(\sfK\) is definable by a set of modal formulas
    2. \(\sfK\) is closed under bisimulations and ultraproducts, and
       \(\bbar{K}\) is closed under ultrapowers
    #+END_theorem

    #+BEGIN_proof
    Assume \(\sfK\) and \(\bbar{\sfK}\) satisfy the stated closure conditions.
    Observe that \(\bbar{\sfK}\) is closed under bisimulations as \(\sfK\) is.
    Define
    \begin{equation*}
    T=\{\phi\mid\forall(\fM,w)\in\sfK:\fM,w\Vdash\phi\}
    \end{equation*}
    We will show that \(T\) defines the class of \(\sfK\).

    Assume \(\fM,w\Vdash T\). Define \(\Sigma=\{\phi\mid\fM,w\Vdash\phi\}\). It is
    obvious that \Sigma is finitely satisfiable in \(\sfK\); for suppose that the set
    \(\{\sigma_1,\dots,\sigma_n\}\subseteq\Sigma\) is not satisfiable in
    \(\sfK\). Then the formula \(\neg(\sigma_1\wedge\dots\wedge\sigma_n)\) would
    be true on all pointed models in \(\sfK\), so it would belong to \(T\), yet
    be false in \(\fM,w\). But then the following claim shows that \Sigma is
    satisfiable in the ultraproduct of pointed models

    *Claim 1* . Let \Sigma be a set of modal formulas, and \(\sfK\) a class of pointed
     models in which \Sigma is finitely satisfiable. Then \Sigma is satisfiable in some
     ultraproduct of models in \(\sfK\)

     /Proof of Claim./ Define in index set \(I\) as the collection of all finite
     subsets of \Sigma
     \begin{equation*}
     I=\{\Sigma_0\subset\Sigma\mid \Sigma_0\text{ is finite}\}
     \end{equation*}
     By assumption, for each \(i\in I\) there is a pointed model \((\fN_i,v_i)\)
     in \(\sfK\) s.t. \(\fN_i,v_i\Vdash i\). We now construct an ultrafilter
     \(U\) over \(I\) s.t. the ultraprodcut \(\prod_U\fN_i\) has a state \(f_U\)
     with \(\prod_U\fN_i,f_U\Vdash\Sigma\)

     For each \(\sigma\in\Sigma\), let \(\widehat{\sigma}\) be the set of all \(i\in
     I\) s.t. \(\sigma\in i\). Then the set
     \(E=\{\widehat{\sigma}\mid\sigma\in\Sigma\}\) has the finite intersection
     property because
     \begin{equation*}
     \{\sigma_1,\dots,\sigma_n\}\in\widehat{\sigma}_1\cap\dots\cap\widehat{\sigma}_n
     \end{equation*}
     So \(E\) can be extended to an ultrafilter \(U\) over \(I\). This defines
     \(\prod_U\fN_i\); for the definition of \(f_U\), let \(W_i\) denote the
     universe of the model \(\fN_i\) and consider the function \(f\in\prod_{i\in
     I}W_i\) s.t. \(f(i)=v_i\).
     It is left to prove that
     \begin{equation*}
     \prod_U\fN_i,f_U\Vdash\Sigma
     \end{equation*}
     Observe that for \(i\in\widehat{\sigma}\) we have \(\sigma\in i\) and so
     \(\fN_i,v_i\Vdash\sigma\). Therefore for each \(\sigma\in\Sigma\)
     \begin{equation*}
     \{i\in I\mid\fN_i,v_i\Vdash\sigma\}\supseteq\widehat{\sigma} \quad\text{ and }\quad
     \widehat{\sigma}\in U
     \end{equation*}
     since \(\sigma\in i\) implies \(\fN_i,v_i\Vdash\sigma\). It follows that
     \(\{i\in I\mid\fN_i,v_i\Vdash\sigma\}\in U\), so by Theorem ref:thmA.19
     \(\prod_U\fN_i,f_U\Vdash\sigma\). Hence \(\prod_U\fN_i,f_U\Vdash\Sigma\)

     It follows from Claim 1 and the closure of \(\sfK\) under taking
     ultraproducts that \Sigma is satisfiable in some pointed model
     \((\fN,v)\in\sfK\). But \(\fN,v\Vdash\Sigma\) implies that \(v\) and the
     state \(w\)  from our _original pointed model \((\fM,w)\) are modally
     equivalent_. So by Theorem ref:thm2.74 there exists an ultrafilter \(U'\)
     s.t.
     \begin{equation*}
     \prod_{U'}(\fN,v),(f_v)_U\leftrightarroweq
     \prod_{U'}(\fM,w),(f_w)_U
     \end{equation*}
     By closure under ultraproducts, the pointed model
     \((\prod_{U'}(\fN,v),(f_v)_U)\) belongs to \(\sfK\). Hence by closure under
     bisimulations, \((\prod_{U'}(\fM,w),(f_w)_U)\) is in \(\sfK\). By closure
     of \(\bbar{K}\) under ultrapowers, \((\fM,w)\in\sfK\)
    #+END_proof

    #+ATTR_LATEX: :options []
    #+BEGIN_theorem
    label:thm2.76
    Let \tau be a modal similarity type, and \(\sfK\) a class of pointed
    \(\tau\)-models. Then the following are equivalent
    1. \(\sfK\) is definable by means of a single modal formula
    2. Both \(\sfK\) and \(\bbar{\sfK}\) are closed under bisimulations and ultraproducts
    #+END_theorem

    #+BEGIN_proof
    Assume \(\sfK,\bbar{\sfK}\) satisfy the stated conditions. Then both are
    closed under ultraproducts, hence by Theorem ref:thm2.75 there are set of
    modal formulas \(T_1,T_2\) defining \(\sfK\) and \(\bbar{\sfK}\)
    respectively. Observe their union is inconsistent in the sense that there is
    no pointed model \((\fM,w)\) s.t. \((\fM,w)\Vdash T_1\cup T_2\). So by
    compactness there exists \(\phi_1,\dots,\phi_n\in T_1\) and
    \(\psi_1,\dots,\psi_m\in T_2\) s.t. for all pointed models \((\fM,w)\)
    \begin{equation*}
    \fM,w\Vdash\phi_1\wedge\dots\wedge\phi_n\to\neg\psi\vee\dots\vee\neg\psi_m
    \end{equation*}
    By definition, for any \((\fM,w)\in\sfK\) we have
    \(\fM,w\Vdash\phi_1\wedge\dots\wedge\phi_n\). Conversely, if
    \(\fM,w\Vdash\phi_1\wedge\dots\wedge\phi_n\), then
    \(\fM,w\Vdash\neg\psi_1\vee\dots\vee\neg\psi_m\). Hence \(\fM,w\not\Vdash
    T_2\). Therefore \((\fM,w)\not\in\bbar{\sfK}\), whence \((\fM,w)\in\sfK\)
    #+END_proof


* COMMENT Completion
  definition

  corollary

  lemma

  theorem

    #+ATTR_LATEX: :options [from Chang&Keisler's Model Theory p212]
    #+BEGIN_lemma
    label:changprop4.1.1
    Let \(E\) be any subset of \(\calp(I)\) and let \(D\) be the filter
    generated by \(E\). Then
    1. \(D\) is a filter over \(I\)
    2. \(D\) is the set of all \(X\in\calp(I)\) s.t. either \(X\equiv I\) or for
       some \(Y_1,\dots,Y_n\in E\)
       \begin{equation*}
       Y_1\cap\dots\cap Y_n\subset X
       \end{equation*}
    3. \(D\) is a proper filter iff \(E\) has the finite intersection property
    #+END_lemma

    #+BEGIN_proof
    2. [@2] Let \(D'\) be the set of all \(X\in\calp(I)\) s.t. \(X=I\) or fro
       some \(Y_1,\dots,Y_n\in E\), \(Y_1\cap\dots\cap Y_n\subset X\). We show
       that \(D=D'\). We have put \(I\in D'\). Let \(X,X'\in D'\) and let
       \(Y_i,Y_j'\in E\) s.t.
       \begin{equation*}
       Y_1\cap\dots\cap Y_n\subset X,\quad
       Y_1'\cap\dots\cap Y_m'\subset X'
       \end{equation*}
       If \(X\subset Z\subset I\), then
       \begin{equation*}
       Y_1\cap\dots\cap Y_n\subset Z
       \end{equation*}
       so \(Z\in D'\). Moreover
       \begin{equation*}
       Y_1\cap\dots\cap Y_n\cap Y_1'\cap\dots\cap Y_m'\subset X\cap X'
       \end{equation*}
       so \(X\cap X'\in D'\). Therefore \(D'\) is a filter over \(I\). Obviously
       \(E\subset D'\). It follows that \(D\subset D'\)

       Now consider any filter \(F\) over \(I\) which includes \(E\). Then
       \(I\in F\). For any \(Y_1,\dots,Y_n\in E\), we have \(Y_1\cap\dots\cap
       Y_n\in F\), and hence any \(X\in\calp(I)\), which includes
       \(Y_1\cap\dots\cap Y_n\) belongs to \(F\). Thus \(D'\subset F\) and hence
       \(D'\subset D\), whence \(D=D'\)
    #+END_proof
